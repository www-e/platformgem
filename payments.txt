â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                    PAYMENT & ENROLLMENT SERVICES REPORT
                           Core System Files
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Generated on: 8/8/2025, 7:07:05 PM
Location: Egypt

â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
ğŸ”¥ CORE PAYMENT SERVICES
â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ

â–¼ Payment Processing Core
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

ğŸ“„ FILE: route.ts
ğŸ“‚ PATH: src/app/api/payments/initiate/route.ts
ğŸ“Š STATS: 303 lines | 8.57 KB
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ FILE CONTENT:                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   1 â”‚ // src/app/api/payments/initiate/route.ts
   2 â”‚ import { NextRequest } from "next/server";
   3 â”‚ import { auth } from "@/lib/auth";
   4 â”‚ import prisma from "@/lib/prisma";
   5 â”‚ import { payMobService } from "@/lib/paymob/client";
   6 â”‚ import {
   7 â”‚   createSuccessResponse,
   8 â”‚   createErrorResponse,
   9 â”‚   ApiErrors,
  10 â”‚ } from "@/lib/api-utils";
  11 â”‚ import { z } from "zod";
  12 â”‚ import {
  13 â”‚   createStandardErrorResponse,
  14 â”‚   API_ERROR_CODES,
  15 â”‚   getErrorMessage,
  16 â”‚ } from "@/lib/api-error-handler";
  17 â”‚ import { paymobConfig } from '@/lib/paymob/config';
  18 â”‚ 
  19 â”‚ 
  20 â”‚ // Validation schema for payment initiation
  21 â”‚ const paymentInitiateSchema = z.object({
  22 â”‚   courseId: z.string().min(1, "Ù…Ø¹Ø±Ù Ø§Ù„Ø¯ÙˆØ±Ø© Ù…Ø·Ù„ÙˆØ¨"),
  23 â”‚   paymentMethod: z.enum(["credit-card", "e-wallet"]).default("credit-card"),
  24 â”‚ });
  25 â”‚ 
  26 â”‚ // POST /api/payments/initiate - Initiate payment for a course
  27 â”‚ export async function POST(request: NextRequest) {
  28 â”‚   try {
  29 â”‚     const session = await auth();
  30 â”‚ 
  31 â”‚     // Check authentication
  32 â”‚     if (!session?.user) {
  33 â”‚       return createErrorResponse(
  34 â”‚         ApiErrors.UNAUTHORIZED.code,
  35 â”‚         ApiErrors.UNAUTHORIZED.message,
  36 â”‚         ApiErrors.UNAUTHORIZED.status
  37 â”‚       );
  38 â”‚     }
  39 â”‚ 
  40 â”‚     // Only students can make payments (admins can for testing)
  41 â”‚     if (!["STUDENT", "ADMIN"].includes(session.user.role)) {
  42 â”‚       return createErrorResponse(
  43 â”‚         ApiErrors.FORBIDDEN.code,
  44 â”‚         "ØºÙŠØ± Ù…ØµØ±Ø­ Ù„Ùƒ Ø¨Ø¥Ø¬Ø±Ø§Ø¡ Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø¯ÙØ¹",
  45 â”‚         ApiErrors.FORBIDDEN.status
  46 â”‚       );
  47 â”‚     }
  48 â”‚ 
  49 â”‚     // Parse and validate request body
  50 â”‚     const body = await request.json();
  51 â”‚     const validationResult = paymentInitiateSchema.safeParse(body);
  52 â”‚ 
  53 â”‚     if (!validationResult.success) {
  54 â”‚       return createErrorResponse(
  55 â”‚         ApiErrors.VALIDATION_ERROR.code,
  56 â”‚         ApiErrors.VALIDATION_ERROR.message,
  57 â”‚         ApiErrors.VALIDATION_ERROR.status,
  58 â”‚         validationResult.error.issues
  59 â”‚       );
  60 â”‚     }
  61 â”‚ 
  62 â”‚     const { courseId, paymentMethod } = validationResult.data;
  63 â”‚ 
  64 â”‚     // Check if course exists and is published
  65 â”‚     const course = await prisma.course.findFirst({
  66 â”‚       where: {
  67 â”‚         id: courseId,
  68 â”‚         isPublished: true,
  69 â”‚       },
  70 â”‚       include: {
  71 â”‚         professor: {
  72 â”‚           select: {
  73 â”‚             id: true,
  74 â”‚             name: true,
  75 â”‚           },
  76 â”‚         },
  77 â”‚         category: {
  78 â”‚           select: {
  79 â”‚             name: true,
  80 â”‚           },
  81 â”‚         },
  82 â”‚       },
  83 â”‚     });
  84 â”‚ 
  85 â”‚     if (!course) {
  86 â”‚       return createErrorResponse(
  87 â”‚         ApiErrors.NOT_FOUND.code,
  88 â”‚         "Ø§Ù„Ø¯ÙˆØ±Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø© Ø£Ùˆ ØºÙŠØ± Ù…Ù†Ø´ÙˆØ±Ø©",
  89 â”‚         ApiErrors.NOT_FOUND.status
  90 â”‚       );
  91 â”‚     }
  92 â”‚ 
  93 â”‚     // Check if course is paid
  94 â”‚     if (!course.price || Number(course.price) <= 0) {
  95 â”‚       return createErrorResponse(
  96 â”‚         "FREE_COURSE",
  97 â”‚         "Ù‡Ø°Ù‡ Ø§Ù„Ø¯ÙˆØ±Ø© Ù…Ø¬Ø§Ù†ÙŠØ© ÙˆÙ„Ø§ ØªØ­ØªØ§Ø¬ Ù„Ø¯ÙØ¹",
  98 â”‚         400
  99 â”‚       );
 100 â”‚     }
 101 â”‚ 
 102 â”‚     // Check if user is already enrolled
 103 â”‚     const existingEnrollment = await prisma.enrollment.findUnique({
 104 â”‚       where: {
 105 â”‚         userId_courseId: {
 106 â”‚           userId: session.user.id,
 107 â”‚           courseId,
 108 â”‚         },
 109 â”‚       },
 110 â”‚     });
 111 â”‚ 
 112 â”‚     if (existingEnrollment) {
 113 â”‚       return createErrorResponse(
 114 â”‚         ApiErrors.DUPLICATE_ERROR.code,
 115 â”‚         "Ø£Ù†Øª Ù…Ø³Ø¬Ù„ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ø¯ÙˆØ±Ø© Ø¨Ø§Ù„ÙØ¹Ù„",
 116 â”‚         ApiErrors.DUPLICATE_ERROR.status
 117 â”‚       );
 118 â”‚     }
 119 â”‚ 
 120 â”‚     // Check if there's already a pending payment
 121 â”‚     const existingPayment = await prisma.payment.findFirst({
 122 â”‚       where: {
 123 â”‚         userId: session.user.id,
 124 â”‚         courseId,
 125 â”‚         status: "PENDING",
 126 â”‚       },
 127 â”‚       orderBy: {
 128 â”‚         createdAt: "desc",
 129 â”‚       },
 130 â”‚     });
 131 â”‚ 
 132 â”‚     if (existingPayment) {
 133 â”‚       const { isPaymentExpired, getPaymentTimeRemaining } = await import(
 134 â”‚         "@/lib/services/payment-timeout.service"
 135 â”‚       );
 136 â”‚ 
 137 â”‚       if (isPaymentExpired(existingPayment.createdAt)) {
 138 â”‚         // Cancel the old payment and allow new one
 139 â”‚         await prisma.payment.update({
 140 â”‚           where: { id: existingPayment.id },
 141 â”‚           data: {
 142 â”‚             status: "CANCELLED",
 143 â”‚             failureReason: `Payment abandoned - exceeded ${paymobConfig.abandonedPaymentCleanupMinutes} minute limit`,
 144 â”‚             updatedAt: new Date(),
 145 â”‚           },
 146 â”‚         });
 147 â”‚ 
 148 â”‚         console.log("Cancelled abandoned payment:", existingPayment.id);
 149 â”‚       } else {
 150 â”‚         // Payment is recent, return error with remaining time info
 151 â”‚         const timeRemaining = getPaymentTimeRemaining(
 152 â”‚           existingPayment.createdAt
 153 â”‚         );
 154 â”‚ 
 155 â”‚         return createErrorResponse(
 156 â”‚           "PENDING_PAYMENT",
 157 â”‚           `Ù„Ø¯ÙŠÙƒ Ø¹Ù…Ù„ÙŠØ© Ø¯ÙØ¹ Ù…Ø¹Ù„Ù‚Ø© Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø¯ÙˆØ±Ø© Ø¨Ø§Ù„ÙØ¹Ù„. Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: ${timeRemaining.minutes} Ø¯Ù‚ÙŠÙ‚Ø© Ùˆ ${timeRemaining.seconds} Ø«Ø§Ù†ÙŠØ©`,
 158 â”‚           409,
 159 â”‚           {
 160 â”‚             paymentId: existingPayment.id,
 161 â”‚             createdAt: existingPayment.createdAt,
 162 â”‚             expiresAt: new Date(
 163 â”‚               existingPayment.createdAt.getTime() +
 164 â”‚                 paymobConfig.paymentTimeoutMinutes * 60 * 1000
 165 â”‚             ),
 166 â”‚             timeRemaining: timeRemaining,
 167 â”‚             canCancel: true,
 168 â”‚           }
 169 â”‚         );
 170 â”‚       }
 171 â”‚     }
 172 â”‚ 
 173 â”‚     // Prevent professors from buying their own courses
 174 â”‚     if (course.professorId === session.user.id) {
 175 â”‚       return createErrorResponse(
 176 â”‚         "INVALID_PURCHASE",
 177 â”‚         "Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø´Ø±Ø§Ø¡ Ø¯ÙˆØ±ØªÙƒ Ø§Ù„Ø®Ø§ØµØ©",
 178 â”‚         400
 179 â”‚       );
 180 â”‚     }
 181 â”‚ 
 182 â”‚     // Get user information for billing
 183 â”‚     const user = await prisma.user.findUnique({
 184 â”‚       where: { id: session.user.id },
 185 â”‚       select: {
 186 â”‚         name: true,
 187 â”‚         email: true,
 188 â”‚         phone: true,
 189 â”‚       },
 190 â”‚     });
 191 â”‚ 
 192 â”‚     if (!user) {
 193 â”‚       return createErrorResponse(
 194 â”‚         ApiErrors.NOT_FOUND.code,
 195 â”‚         "Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©",
 196 â”‚         ApiErrors.NOT_FOUND.status
 197 â”‚       );
 198 â”‚     }
 199 â”‚ 
 200 â”‚     // Create payment record in database
 201 â”‚     const merchantOrderId = payMobService.generateMerchantOrderId(
 202 â”‚       courseId,
 203 â”‚       session.user.id
 204 â”‚     );
 205 â”‚     const amountCents = payMobService.formatAmount(Number(course.price));
 206 â”‚ 
 207 â”‚     const payment = await prisma.payment.create({
 208 â”‚       data: {
 209 â”‚         userId: session.user.id,
 210 â”‚         courseId,
 211 â”‚         amount: course.price,
 212 â”‚         currency: course.currency,
 213 â”‚         status: "PENDING",
 214 â”‚         paymobOrderId: merchantOrderId,
 215 â”‚       },
 216 â”‚     });
 217 â”‚ 
 218 â”‚     // Prepare PayMob order data
 219 â”‚     const billingData = payMobService.createBillingData({
 220 â”‚       name: user.name,
 221 â”‚       email: user.email || undefined,
 222 â”‚       phone: user.phone,
 223 â”‚     });
 224 â”‚     const orderData = {
 225 â”‚       amount_cents: amountCents,
 226 â”‚       currency: course.currency,
 227 â”‚       merchant_order_id: merchantOrderId,
 228 â”‚       items: [
 229 â”‚         {
 230 â”‚           name: course.title,
 231 â”‚           amount_cents: amountCents,
 232 â”‚           description: `Ø¯ÙˆØ±Ø© ${course.title} - ${course.category.name}`,
 233 â”‚           quantity: 1,
 234 â”‚         },
 235 â”‚       ],
 236 â”‚       billing_data: billingData,
 237 â”‚     };
 238 â”‚ 
 239 â”‚     // Initiate payment with PayMob
 240 â”‚     const paymentResult = await payMobService.initiatePayment(
 241 â”‚       orderData,
 242 â”‚       courseId,
 243 â”‚       paymentMethod
 244 â”‚     );
 245 â”‚ 
 246 â”‚     // Update payment record with PayMob order ID
 247 â”‚     await prisma.payment.update({
 248 â”‚       where: { id: payment.id },
 249 â”‚       data: {
 250 â”‚         paymobOrderId: paymentResult.orderId.toString(),
 251 â”‚         paymobResponse: {
 252 â”‚           paymentKey: paymentResult.paymentKey,
 253 â”‚           orderId: paymentResult.orderId,
 254 â”‚           iframeUrl: paymentResult.iframeUrl,
 255 â”‚           initiatedAt: new Date().toISOString(),
 256 â”‚         },
 257 â”‚       },
 258 â”‚     });
 259 â”‚ 
 260 â”‚     return createSuccessResponse(
 261 â”‚       {
 262 â”‚         paymentId: payment.id,
 263 â”‚         paymentKey: paymentResult.paymentKey,
 264 â”‚         iframeUrl: paymentResult.iframeUrl,
 265 â”‚         orderId: paymentResult.orderId,
 266 â”‚         amount: Number(course.price),
 267 â”‚         currency: course.currency,
 268 â”‚         course: {
 269 â”‚           id: course.id,
 270 â”‚           title: course.title,
 271 â”‚           thumbnailUrl: course.thumbnailUrl,
 272 â”‚           professor: course.professor.name,
 273 â”‚         },
 274 â”‚       },
 275 â”‚       201
 276 â”‚     );
 277 â”‚   } catch (error) {
 278 â”‚     console.error("Payment initiation error:", error);
 279 â”‚ 
 280 â”‚     // Handle PayMob specific errors
 281 â”‚     // Handle PayMob specific errors
 282 â”‚     if (error instanceof Error && error.message.includes("PayMob")) {
 283 â”‚       return createStandardErrorResponse(
 284 â”‚         API_ERROR_CODES.PAYMENT_GATEWAY_ERROR,
 285 â”‚         getErrorMessage(API_ERROR_CODES.PAYMENT_GATEWAY_ERROR),
 286 â”‚         502,
 287 â”‚         {
 288 â”‚           originalError: error.message,
 289 â”‚           gateway: "PayMob",
 290 â”‚           timestamp: new Date().toISOString(),
 291 â”‚         }
 292 â”‚       );
 293 â”‚     }
 294 â”‚ 
 295 â”‚     return createErrorResponse(
 296 â”‚       ApiErrors.INTERNAL_ERROR.code,
 297 â”‚       ApiErrors.INTERNAL_ERROR.message,
 298 â”‚       ApiErrors.INTERNAL_ERROR.status,
 299 â”‚       error
 300 â”‚     );
 301 â”‚   }
 302 â”‚ }
 303 â”‚ 

â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²
END OF FILE: route.ts
â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²


ğŸ“„ FILE: route.ts
ğŸ“‚ PATH: src/app/api/payments/webhook/route.ts
ğŸ“Š STATS: 697 lines | 22.92 KB
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ FILE CONTENT:                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   1 â”‚ // src/app/api/payments/webhook/route.ts
   2 â”‚ import { NextRequest } from "next/server";
   3 â”‚ import prisma from "@/lib/prisma";
   4 â”‚ import { payMobService } from "@/lib/paymob/client";
   5 â”‚ import { createSuccessResponse, createErrorResponse } from "@/lib/api-utils";
   6 â”‚ import { 
   7 â”‚   createStandardErrorResponse, 
   8 â”‚   createStandardSuccessResponse,
   9 â”‚   API_ERROR_CODES 
  10 â”‚ } from "@/lib/api-error-handler";
  11 â”‚ // Webhook retry configuration
  12 â”‚ const WEBHOOK_RETRY_CONFIG = {
  13 â”‚   maxRetries: 3,
  14 â”‚   retryDelays: [1000, 5000, 15000], // 1s, 5s, 15s
  15 â”‚ };
  16 â”‚ 
  17 â”‚ /**
  18 â”‚  * Process webhook with retry mechanism for transient failures
  19 â”‚  */
  20 â”‚ async function processWebhookWithRetry(
  21 â”‚   payment: any,
  22 â”‚   processedData: any,
  23 â”‚   webhookData: any,
  24 â”‚   validatedTransactionId: number,
  25 â”‚   existingWebhook: any,
  26 â”‚   retryCount = 0
  27 â”‚ ): Promise<any> {
  28 â”‚   try {
  29 â”‚     // Your existing transaction code will go here
  30 â”‚     // We'll move the main transaction logic into this function
  31 â”‚     
  32 â”‚     // Determine new payment status
  33 â”‚     const newStatus = processedData.isSuccess ? "COMPLETED" : "FAILED";
  34 â”‚     const completedAt = processedData.isSuccess ? new Date() : null;
  35 â”‚     const failureReason = !processedData.isSuccess
  36 â”‚       ? "Payment failed at PayMob gateway"
  37 â”‚       : null;
  38 â”‚ 
  39 â”‚     // Execute payment update and enrollment creation in a single transaction
  40 â”‚     const transactionResult = await prisma.$transaction(async (tx) => {
  41 â”‚       // Create or update webhook record
  42 â”‚       const webhookId =
  43 â”‚         existingWebhook?.id ||
  44 â”‚         `webhook_${validatedTransactionId}_${Date.now()}`;
  45 â”‚ 
  46 â”‚       if (existingWebhook) {
  47 â”‚         await tx.paymentWebhook.update({
  48 â”‚           where: { id: existingWebhook.id },
  49 â”‚           data: {
  50 â”‚             webhookPayload: webhookData,
  51 â”‚             processedAt: new Date(),
  52 â”‚             processingAttempts: existingWebhook.processingAttempts + 1,
  53 â”‚             lastError: null,
  54 â”‚           },
  55 â”‚         });
  56 â”‚       } else {
  57 â”‚         await tx.paymentWebhook.create({
  58 â”‚           data: {
  59 â”‚             id: webhookId,
  60 â”‚             paymentId: payment.id,
  61 â”‚             paymobTransactionId: BigInt(validatedTransactionId),
  62 â”‚             webhookPayload: webhookData,
  63 â”‚             processedAt: new Date(),
  64 â”‚             processingAttempts: 1,
  65 â”‚           },
  66 â”‚         });
  67 â”‚       }
  68 â”‚ 
  69 â”‚       // Update payment record
  70 â”‚       const updatedPayment = await tx.payment.update({
  71 â”‚         where: { id: payment.id },
  72 â”‚         data: {
  73 â”‚           status: newStatus,
  74 â”‚           paymobTransactionId: BigInt(validatedTransactionId),
  75 â”‚           completedAt,
  76 â”‚           failureReason,
  77 â”‚           paymobResponse: {
  78 â”‚             ...(payment.paymobResponse as any),
  79 â”‚             webhook: {
  80 â”‚               transactionId: validatedTransactionId,
  81 â”‚               success: processedData.isSuccess,
  82 â”‚               amountCents: processedData.amountCents,
  83 â”‚               currency: processedData.currency,
  84 â”‚               processedAt: new Date().toISOString(),
  85 â”‚               rawData: webhookData,
  86 â”‚               retryCount,
  87 â”‚             },
  88 â”‚           },
  89 â”‚         },
  90 â”‚       });
  91 â”‚ 
  92 â”‚       // For successful payments, create enrollment within the same transaction
  93 â”‚       let enrollmentResult = null;
  94 â”‚       if (processedData.isSuccess) {
  95 â”‚         try {
  96 â”‚           // Check if enrollment already exists
  97 â”‚           const existingEnrollment = await tx.enrollment.findUnique({
  98 â”‚             where: {
  99 â”‚               userId_courseId: {
 100 â”‚                 userId: payment.userId,
 101 â”‚                 courseId: payment.courseId,
 102 â”‚               },
 103 â”‚             },
 104 â”‚           });
 105 â”‚ 
 106 â”‚           if (!existingEnrollment) {
 107 â”‚             // Create enrollment
 108 â”‚             const newEnrollment = await tx.enrollment.create({
 109 â”‚               data: {
 110 â”‚                 userId: payment.userId,
 111 â”‚                 courseId: payment.courseId,
 112 â”‚                 progressPercent: 0,
 113 â”‚                 completedLessonIds: [],
 114 â”‚                 totalWatchTime: 0,
 115 â”‚                 enrolledAt: new Date(),
 116 â”‚                 lastAccessedAt: null,
 117 â”‚               },
 118 â”‚             });
 119 â”‚ 
 120 â”‚             // Create progress milestone
 121 â”‚             await tx.progressMilestone.create({
 122 â”‚               data: {
 123 â”‚                 userId: payment.userId,
 124 â”‚                 courseId: payment.courseId,
 125 â”‚                 milestoneType: 'COURSE_START',
 126 â”‚                 metadata: {
 127 â”‚                   paymentId: payment.id,
 128 â”‚                   enrollmentId: newEnrollment.id,
 129 â”‚                   courseName: payment.course.title,
 130 â”‚                   amount: Number(payment.amount),
 131 â”‚                   webhookTransactionId: validatedTransactionId,
 132 â”‚                   retryCount,
 133 â”‚                 },
 134 â”‚               },
 135 â”‚             });
 136 â”‚ 
 137 â”‚             enrollmentResult = {
 138 â”‚               success: true,
 139 â”‚               enrollmentId: newEnrollment.id,
 140 â”‚               created: true,
 141 â”‚             };
 142 â”‚ 
 143 â”‚             console.log('Enrollment created within transaction:', {
 144 â”‚               enrollmentId: newEnrollment.id,
 145 â”‚               paymentId: payment.id,
 146 â”‚               userId: payment.userId,
 147 â”‚               courseId: payment.courseId,
 148 â”‚               retryCount,
 149 â”‚             });
 150 â”‚           } else {
 151 â”‚             enrollmentResult = {
 152 â”‚               success: true,
 153 â”‚               enrollmentId: existingEnrollment.id,
 154 â”‚               created: false,
 155 â”‚             };
 156 â”‚ 
 157 â”‚             console.log('Enrollment already exists:', {
 158 â”‚               enrollmentId: existingEnrollment.id,
 159 â”‚               paymentId: payment.id,
 160 â”‚               retryCount,
 161 â”‚             });
 162 â”‚           }
 163 â”‚         } catch (enrollmentError) {
 164 â”‚           console.error('Enrollment creation failed within transaction:', enrollmentError);
 165 â”‚           
 166 â”‚           // Store enrollment error in payment record for manual review
 167 â”‚           await tx.payment.update({
 168 â”‚             where: { id: payment.id },
 169 â”‚             data: {
 170 â”‚               paymobResponse: {
 171 â”‚                 ...(updatedPayment.paymobResponse as any),
 172 â”‚                 enrollmentError: {
 173 â”‚                   error: enrollmentError instanceof Error ? enrollmentError.message : 'Unknown error',
 174 â”‚                   timestamp: new Date().toISOString(),
 175 â”‚                   requiresManualReview: true,
 176 â”‚                   retryCount,
 177 â”‚                 },
 178 â”‚               },
 179 â”‚             },
 180 â”‚           });
 181 â”‚ 
 182 â”‚           // Don't throw - let payment complete but flag for manual enrollment
 183 â”‚           enrollmentResult = {
 184 â”‚             success: false,
 185 â”‚             error: enrollmentError instanceof Error ? enrollmentError.message : 'Unknown error',
 186 â”‚             requiresManualReview: true,
 187 â”‚           };
 188 â”‚         }
 189 â”‚       }
 190 â”‚ 
 191 â”‚       return {
 192 â”‚         payment: updatedPayment,
 193 â”‚         enrollment: enrollmentResult,
 194 â”‚       };
 195 â”‚     }, {
 196 â”‚       timeout: 30000, // 30 second timeout
 197 â”‚     });
 198 â”‚ 
 199 â”‚     return transactionResult;
 200 â”‚ 
 201 â”‚   } catch (error) {
 202 â”‚     console.error(`Webhook processing failed (attempt ${retryCount + 1}):`, error);
 203 â”‚     
 204 â”‚     // Check if this is a retryable error
 205 â”‚     const isRetryableError = 
 206 â”‚       error instanceof Error && (
 207 â”‚         error.message.includes('timeout') ||
 208 â”‚         error.message.includes('connection') ||
 209 â”‚         error.message.includes('deadlock') ||
 210 â”‚         error.message.includes('serialization')
 211 â”‚       );
 212 â”‚ 
 213 â”‚     if (isRetryableError && retryCount < WEBHOOK_RETRY_CONFIG.maxRetries) {
 214 â”‚       console.log(`Retrying webhook processing in ${WEBHOOK_RETRY_CONFIG.retryDelays[retryCount]}ms...`);
 215 â”‚       
 216 â”‚       // Wait before retry
 217 â”‚       await new Promise(resolve => 
 218 â”‚         setTimeout(resolve, WEBHOOK_RETRY_CONFIG.retryDelays[retryCount])
 219 â”‚       );
 220 â”‚       
 221 â”‚       // Retry with incremented count
 222 â”‚       return processWebhookWithRetry(
 223 â”‚         payment,
 224 â”‚         processedData,
 225 â”‚         webhookData,
 226 â”‚         validatedTransactionId,
 227 â”‚         existingWebhook,
 228 â”‚         retryCount + 1
 229 â”‚       );
 230 â”‚     }
 231 â”‚ 
 232 â”‚     // Non-retryable error or max retries exceeded
 233 â”‚     throw error;
 234 â”‚   }
 235 â”‚ }
 236 â”‚ // POST /api/payments/webhook - Handle PayMob webhook notifications
 237 â”‚ export async function POST(request: NextRequest) {
 238 â”‚   let webhookData: any;
 239 â”‚   let transactionId: number | null = null;
 240 â”‚ 
 241 â”‚   try {
 242 â”‚     // Parse webhook data
 243 â”‚     webhookData = await request.json();
 244 â”‚     transactionId = webhookData?.obj?.id ?? null;
 245 â”‚ 
 246 â”‚     console.log("PayMob webhook received:", {
 247 â”‚       transactionId: transactionId,
 248 â”‚       orderId: webhookData?.obj?.order?.id,
 249 â”‚       success: webhookData?.obj?.success,
 250 â”‚       amount: webhookData?.obj?.amount_cents,
 251 â”‚       timestamp: new Date().toISOString(),
 252 â”‚     });
 253 â”‚ 
 254 â”‚     // We process the 'obj' part of the payload
 255 â”‚     const webhookObject = webhookData.obj;
 256 â”‚ 
 257 â”‚     // Validate webhook payload structure
 258 â”‚     if (!payMobService.validateWebhookPayload(webhookObject)) {
 259 â”‚       console.error("Invalid webhook payload structure:", webhookObject);
 260 â”‚       return createStandardErrorResponse(
 261 â”‚         API_ERROR_CODES.WEBHOOK_PAYLOAD_INVALID,
 262 â”‚         "Invalid webhook payload structure",
 263 â”‚         400,
 264 â”‚         { receivedPayload: webhookObject }
 265 â”‚       );
 266 â”‚       
 267 â”‚     }
 268 â”‚ 
 269 â”‚     // Verify webhook signature
 270 â”‚     const isValidSignature = await payMobService.verifyWebhookSignature(
 271 â”‚       webhookObject
 272 â”‚     );
 273 â”‚     if (!isValidSignature) {
 274 â”‚       console.error(
 275 â”‚         "Invalid PayMob webhook signature for transaction:",
 276 â”‚         transactionId
 277 â”‚       );
 278 â”‚       return createStandardErrorResponse(
 279 â”‚         API_ERROR_CODES.WEBHOOK_SIGNATURE_INVALID,
 280 â”‚         "Invalid webhook signature",
 281 â”‚         401,
 282 â”‚         { transactionId: transactionId }
 283 â”‚       );
 284 â”‚       
 285 â”‚     }
 286 â”‚ 
 287 â”‚     // Process webhook data
 288 â”‚     const processedData = await payMobService.processWebhook(webhookObject);
 289 â”‚ 
 290 â”‚     // Validate processed data
 291 â”‚     if (!processedData.isValid) {
 292 â”‚       console.error("Invalid webhook data processing");
 293 â”‚       return createErrorResponse(
 294 â”‚         "WEBHOOK_INVALID",
 295 â”‚         "Invalid webhook data",
 296 â”‚         400
 297 â”‚       );
 298 â”‚     }
 299 â”‚ 
 300 â”‚     // *** FIX: Ensure transactionId is valid before proceeding ***
 301 â”‚     if (!processedData.transactionId) {
 302 â”‚       console.error("Missing transaction ID in webhook data");
 303 â”‚       return createErrorResponse(
 304 â”‚         "WEBHOOK_MISSING_DATA",
 305 â”‚         "Missing transaction ID",
 306 â”‚         400
 307 â”‚       );
 308 â”‚     }
 309 â”‚ 
 310 â”‚     const validatedTransactionId = processedData.transactionId; // Now we know it's a number
 311 â”‚ 
 312 â”‚     // Build search conditions
 313 â”‚     const searchConditions = [];
 314 â”‚     if (processedData.orderId) {
 315 â”‚       searchConditions.push({
 316 â”‚         paymobOrderId: processedData.orderId.toString(),
 317 â”‚       });
 318 â”‚     }
 319 â”‚     if (processedData.merchantOrderId) {
 320 â”‚       searchConditions.push({ paymobOrderId: processedData.merchantOrderId });
 321 â”‚     }
 322 â”‚ 
 323 â”‚     if (searchConditions.length === 0) {
 324 â”‚       console.error("No order ID or merchant order ID in webhook data");
 325 â”‚       return createErrorResponse(
 326 â”‚         "WEBHOOK_MISSING_ORDER_ID",
 327 â”‚         "Missing order identification",
 328 â”‚         400
 329 â”‚       );
 330 â”‚     }
 331 â”‚ 
 332 â”‚     // Find the payment record
 333 â”‚     const payment = await prisma.payment.findFirst({
 334 â”‚       where: { OR: searchConditions },
 335 â”‚       include: {
 336 â”‚         user: { select: { id: true, name: true, email: true } },
 337 â”‚         course: { select: { id: true, title: true, professorId: true } },
 338 â”‚       },
 339 â”‚     });
 340 â”‚ 
 341 â”‚     if (!payment) {
 342 â”‚       console.error("Payment not found for webhook:", {
 343 â”‚         orderId: processedData.orderId,
 344 â”‚         merchantOrderId: processedData.merchantOrderId,
 345 â”‚         transactionId: validatedTransactionId,
 346 â”‚       });
 347 â”‚ 
 348 â”‚       // Store webhook for manual review
 349 â”‚       await prisma.paymentWebhook
 350 â”‚         .create({
 351 â”‚           data: {
 352 â”‚             id: `webhook_${validatedTransactionId}_${Date.now()}`,
 353 â”‚             paymentId: "unknown", // Will need manual linking
 354 â”‚             paymobTransactionId: BigInt(validatedTransactionId),
 355 â”‚             webhookPayload: webhookData,
 356 â”‚             lastError: "Payment record not found",
 357 â”‚             processingAttempts: 1,
 358 â”‚           },
 359 â”‚         })
 360 â”‚         .catch((err: unknown) => {
 361 â”‚           console.error("Failed to store orphaned webhook:", err);
 362 â”‚         });
 363 â”‚ 
 364 â”‚       return createErrorResponse(
 365 â”‚         "PAYMENT_NOT_FOUND",
 366 â”‚         "Payment record not found",
 367 â”‚         404
 368 â”‚       );
 369 â”‚     }
 370 â”‚ 
 371 â”‚     // Check for duplicate webhook processing (idempotency)
 372 â”‚     const existingWebhook = await prisma.paymentWebhook.findFirst({
 373 â”‚       where: {
 374 â”‚         paymentId: payment.id,
 375 â”‚         paymobTransactionId: BigInt(validatedTransactionId),
 376 â”‚       },
 377 â”‚     });
 378 â”‚ 
 379 â”‚     // Enhanced idempotency check
 380 â”‚     if (existingWebhook && existingWebhook.processedAt) {
 381 â”‚       // Check if payment status matches webhook result
 382 â”‚       const expectedStatus = processedData.isSuccess ? "COMPLETED" : "FAILED";
 383 â”‚ 
 384 â”‚       if (payment.status === expectedStatus) {
 385 â”‚         console.log("Webhook already processed successfully:", {
 386 â”‚           paymentId: payment.id,
 387 â”‚           transactionId: validatedTransactionId,
 388 â”‚           processedAt: existingWebhook.processedAt,
 389 â”‚           status: payment.status,
 390 â”‚         });
 391 â”‚ 
 392 â”‚         return createSuccessResponse({
 393 â”‚           message: "Webhook already processed",
 394 â”‚           paymentId: payment.id,
 395 â”‚           status: payment.status,
 396 â”‚           transactionId: validatedTransactionId,
 397 â”‚           processedAt: existingWebhook.processedAt,
 398 â”‚           alreadyProcessed: true,
 399 â”‚         });
 400 â”‚       } else {
 401 â”‚         // Status mismatch - this could indicate a problem
 402 â”‚         console.warn("Webhook processed but payment status mismatch:", {
 403 â”‚           paymentId: payment.id,
 404 â”‚           transactionId: validatedTransactionId,
 405 â”‚           expectedStatus,
 406 â”‚           currentStatus: payment.status,
 407 â”‚           webhookProcessedAt: existingWebhook.processedAt,
 408 â”‚         });
 409 â”‚ 
 410 â”‚         // Mark for manual review but don't reprocess
 411 â”‚         await prisma.paymentWebhook.update({
 412 â”‚           where: { id: existingWebhook.id },
 413 â”‚           data: {
 414 â”‚             lastError: `Status mismatch: expected ${expectedStatus}, found ${payment.status}`,
 415 â”‚             processingAttempts: existingWebhook.processingAttempts + 1,
 416 â”‚           },
 417 â”‚         });
 418 â”‚ 
 419 â”‚         return createSuccessResponse({
 420 â”‚           message: "Webhook already processed but status mismatch detected",
 421 â”‚           paymentId: payment.id,
 422 â”‚           status: payment.status,
 423 â”‚           requiresManualReview: true,
 424 â”‚           processedAt: existingWebhook.processedAt,
 425 â”‚         });
 426 â”‚       }
 427 â”‚     }
 428 â”‚ 
 429 â”‚     // Check for potential duplicate transactions with different order IDs
 430 â”‚     const duplicateTransaction = await prisma.paymentWebhook.findFirst({
 431 â”‚       where: {
 432 â”‚         paymobTransactionId: BigInt(validatedTransactionId),
 433 â”‚         paymentId: { not: payment.id },
 434 â”‚         processedAt: { not: null },
 435 â”‚       },
 436 â”‚     });
 437 â”‚ 
 438 â”‚     if (duplicateTransaction) {
 439 â”‚       console.warn("Duplicate transaction ID detected:", {
 440 â”‚         transactionId: validatedTransactionId,
 441 â”‚         currentPaymentId: payment.id,
 442 â”‚         existingPaymentId: duplicateTransaction.paymentId,
 443 â”‚       });
 444 â”‚ 
 445 â”‚       // Store this webhook for manual review
 446 â”‚       await prisma.paymentWebhook.create({
 447 â”‚         data: {
 448 â”‚           id: `webhook_${validatedTransactionId}_duplicate_${Date.now()}`,
 449 â”‚           paymentId: payment.id,
 450 â”‚           paymobTransactionId: BigInt(validatedTransactionId),
 451 â”‚           webhookPayload: webhookData,
 452 â”‚           lastError: `Duplicate transaction ID - already processed for payment ${duplicateTransaction.paymentId}`,
 453 â”‚           processingAttempts: 1,
 454 â”‚         },
 455 â”‚       });
 456 â”‚ 
 457 â”‚       return createErrorResponse(
 458 â”‚         "DUPLICATE_TRANSACTION",
 459 â”‚         "Duplicate transaction ID detected",
 460 â”‚         409
 461 â”‚       );
 462 â”‚     }
 463 â”‚ 
 464 â”‚     // Determine new payment status
 465 â”‚     const newStatus = processedData.isSuccess ? "COMPLETED" : "FAILED";
 466 â”‚     const completedAt = processedData.isSuccess ? new Date() : null;
 467 â”‚     const failureReason = !processedData.isSuccess
 468 â”‚       ? "Payment failed at PayMob gateway"
 469 â”‚       : null;
 470 â”‚ 
 471 â”‚     // Execute payment update and enrollment creation in a single transaction
 472 â”‚     const transactionResult = await prisma.$transaction(async (tx) => {
 473 â”‚       // Create or update webhook record
 474 â”‚       const webhookId =
 475 â”‚         existingWebhook?.id ||
 476 â”‚         `webhook_${validatedTransactionId}_${Date.now()}`;
 477 â”‚ 
 478 â”‚       if (existingWebhook) {
 479 â”‚         await tx.paymentWebhook.update({
 480 â”‚           where: { id: existingWebhook.id },
 481 â”‚           data: {
 482 â”‚             webhookPayload: webhookData,
 483 â”‚             processedAt: new Date(),
 484 â”‚             processingAttempts: existingWebhook.processingAttempts + 1,
 485 â”‚             lastError: null,
 486 â”‚           },
 487 â”‚         });
 488 â”‚       } else {
 489 â”‚         await tx.paymentWebhook.create({
 490 â”‚           data: {
 491 â”‚             id: webhookId,
 492 â”‚             paymentId: payment.id,
 493 â”‚             paymobTransactionId: BigInt(validatedTransactionId),
 494 â”‚             webhookPayload: webhookData,
 495 â”‚             processedAt: new Date(),
 496 â”‚             processingAttempts: 1,
 497 â”‚           },
 498 â”‚         });
 499 â”‚       }
 500 â”‚ 
 501 â”‚       // Update payment record
 502 â”‚       const updatedPayment = await tx.payment.update({
 503 â”‚         where: { id: payment.id },
 504 â”‚         data: {
 505 â”‚           status: newStatus,
 506 â”‚           paymobTransactionId: BigInt(validatedTransactionId),
 507 â”‚           completedAt,
 508 â”‚           failureReason,
 509 â”‚           paymobResponse: {
 510 â”‚             ...(payment.paymobResponse as any),
 511 â”‚             webhook: {
 512 â”‚               transactionId: validatedTransactionId,
 513 â”‚               success: processedData.isSuccess,
 514 â”‚               amountCents: processedData.amountCents,
 515 â”‚               currency: processedData.currency,
 516 â”‚               processedAt: new Date().toISOString(),
 517 â”‚               rawData: webhookData,
 518 â”‚             },
 519 â”‚           },
 520 â”‚         },
 521 â”‚       });
 522 â”‚ 
 523 â”‚       // For successful payments, create enrollment within the same transaction
 524 â”‚       let enrollmentResult = null;
 525 â”‚       if (processedData.isSuccess) {
 526 â”‚         try {
 527 â”‚           // Check if enrollment already exists
 528 â”‚           const existingEnrollment = await tx.enrollment.findUnique({
 529 â”‚             where: {
 530 â”‚               userId_courseId: {
 531 â”‚                 userId: payment.userId,
 532 â”‚                 courseId: payment.courseId,
 533 â”‚               },
 534 â”‚             },
 535 â”‚           });
 536 â”‚ 
 537 â”‚           if (!existingEnrollment) {
 538 â”‚             // Create enrollment
 539 â”‚             const newEnrollment = await tx.enrollment.create({
 540 â”‚               data: {
 541 â”‚                 userId: payment.userId,
 542 â”‚                 courseId: payment.courseId,
 543 â”‚                 progressPercent: 0,
 544 â”‚                 completedLessonIds: [],
 545 â”‚                 totalWatchTime: 0,
 546 â”‚                 enrolledAt: new Date(),
 547 â”‚                 lastAccessedAt: null,
 548 â”‚               },
 549 â”‚             });
 550 â”‚ 
 551 â”‚             // Create progress milestone
 552 â”‚             await tx.progressMilestone.create({
 553 â”‚               data: {
 554 â”‚                 userId: payment.userId,
 555 â”‚                 courseId: payment.courseId,
 556 â”‚                 milestoneType: "COURSE_START",
 557 â”‚                 metadata: {
 558 â”‚                   paymentId: payment.id,
 559 â”‚                   enrollmentId: newEnrollment.id,
 560 â”‚                   courseName: payment.course.title,
 561 â”‚                   amount: Number(payment.amount),
 562 â”‚                   webhookTransactionId: validatedTransactionId,
 563 â”‚                 },
 564 â”‚               },
 565 â”‚             });
 566 â”‚ 
 567 â”‚             enrollmentResult = {
 568 â”‚               success: true,
 569 â”‚               enrollmentId: newEnrollment.id,
 570 â”‚               created: true,
 571 â”‚             };
 572 â”‚ 
 573 â”‚             console.log("Enrollment created within transaction:", {
 574 â”‚               enrollmentId: newEnrollment.id,
 575 â”‚               paymentId: payment.id,
 576 â”‚               userId: payment.userId,
 577 â”‚               courseId: payment.courseId,
 578 â”‚             });
 579 â”‚           } else {
 580 â”‚             enrollmentResult = {
 581 â”‚               success: true,
 582 â”‚               enrollmentId: existingEnrollment.id,
 583 â”‚               created: false,
 584 â”‚             };
 585 â”‚ 
 586 â”‚             console.log("Enrollment already exists:", {
 587 â”‚               enrollmentId: existingEnrollment.id,
 588 â”‚               paymentId: payment.id,
 589 â”‚             });
 590 â”‚           }
 591 â”‚         } catch (enrollmentError) {
 592 â”‚           console.error(
 593 â”‚             "Enrollment creation failed within transaction:",
 594 â”‚             enrollmentError
 595 â”‚           );
 596 â”‚ 
 597 â”‚           // Store enrollment error in payment record for manual review
 598 â”‚           await tx.payment.update({
 599 â”‚             where: { id: payment.id },
 600 â”‚             data: {
 601 â”‚               paymobResponse: {
 602 â”‚                 ...(updatedPayment.paymobResponse as any),
 603 â”‚                 enrollmentError: {
 604 â”‚                   error:
 605 â”‚                     enrollmentError instanceof Error
 606 â”‚                       ? enrollmentError.message
 607 â”‚                       : "Unknown error",
 608 â”‚                   timestamp: new Date().toISOString(),
 609 â”‚                   requiresManualReview: true,
 610 â”‚                 },
 611 â”‚               },
 612 â”‚             },
 613 â”‚           });
 614 â”‚ 
 615 â”‚           // Don't throw - let payment complete but flag for manual enrollment
 616 â”‚           enrollmentResult = {
 617 â”‚             success: false,
 618 â”‚             error:
 619 â”‚               enrollmentError instanceof Error
 620 â”‚                 ? enrollmentError.message
 621 â”‚                 : "Unknown error",
 622 â”‚             requiresManualReview: true,
 623 â”‚           };
 624 â”‚         }
 625 â”‚       }
 626 â”‚ 
 627 â”‚       return {
 628 â”‚         payment: updatedPayment,
 629 â”‚         enrollment: enrollmentResult,
 630 â”‚       };
 631 â”‚     });
 632 â”‚ 
 633 â”‚     console.log("Payment webhook processed:", {
 634 â”‚       paymentId: payment.id,
 635 â”‚       status: newStatus,
 636 â”‚       transactionId: validatedTransactionId,
 637 â”‚       success: processedData.isSuccess,
 638 â”‚       enrollmentCreated: transactionResult.enrollment?.success || false,
 639 â”‚       enrollmentId: transactionResult.enrollment?.enrollmentId,
 640 â”‚       enrollmentRequiresManualReview:
 641 â”‚         transactionResult.enrollment?.requiresManualReview || false,
 642 â”‚     });
 643 â”‚ 
 644 â”‚     return createStandardSuccessResponse({
 645 â”‚       paymentId: payment.id,
 646 â”‚       status: newStatus,
 647 â”‚       transactionId: validatedTransactionId,
 648 â”‚       enrollment: {
 649 â”‚         created: transactionResult.enrollment?.success || false,
 650 â”‚         enrollmentId: transactionResult.enrollment?.enrollmentId,
 651 â”‚         requiresManualReview: transactionResult.enrollment?.requiresManualReview || false,
 652 â”‚       },
 653 â”‚     }, "Webhook processed successfully");
 654 â”‚     
 655 â”‚   } catch (error) {
 656 â”‚     console.error("PayMob webhook processing error:", error);
 657 â”‚ 
 658 â”‚     // *** FIX: Use correct `transactionId` variable and check if it exists ***
 659 â”‚     if (transactionId && webhookData) {
 660 â”‚       try {
 661 â”‚         await prisma.paymentWebhook.upsert({
 662 â”‚           where: { id: `webhook_${transactionId}_error_${Date.now()}` },
 663 â”‚           create: {
 664 â”‚             id: `webhook_${transactionId}_error_${Date.now()}`,
 665 â”‚             paymentId: "error", // Will need manual linking
 666 â”‚             paymobTransactionId: BigInt(transactionId),
 667 â”‚             webhookPayload: webhookData,
 668 â”‚             lastError: error instanceof Error ? error.message : "Unknown error",
 669 â”‚             processingAttempts: 1,
 670 â”‚           },
 671 â”‚           update: {
 672 â”‚             processingAttempts: { increment: 1 },
 673 â”‚             lastError: error instanceof Error ? error.message : "Unknown error",
 674 â”‚             webhookPayload: webhookData,
 675 â”‚           },
 676 â”‚         });
 677 â”‚       } catch (dbError) {
 678 â”‚         console.error("Failed to store error webhook:", dbError);
 679 â”‚       }
 680 â”‚     }
 681 â”‚ 
 682 â”‚     return createSuccessResponse({
 683 â”‚       message: "Webhook received but processing failed",
 684 â”‚       error: error instanceof Error ? error.message : "Unknown error",
 685 â”‚       transactionId,
 686 â”‚     });
 687 â”‚   }
 688 â”‚ }
 689 â”‚ 
 690 â”‚ // GET /api/payments/webhook - Health check for webhook endpoint
 691 â”‚ export async function GET() {
 692 â”‚   return createSuccessResponse({
 693 â”‚     message: "PayMob webhook endpoint is active",
 694 â”‚     timestamp: new Date().toISOString(),
 695 â”‚   });
 696 â”‚ }
 697 â”‚ 

â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²
END OF FILE: route.ts
â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²


ğŸ“„ FILE: client.ts
ğŸ“‚ PATH: src/lib/paymob/client.ts
ğŸ“Š STATS: 217 lines | 7.05 KB
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ FILE CONTENT:                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   1 â”‚ // src/lib/paymob/client.ts
   2 â”‚ 
   3 â”‚ import { paymobConfig } from "./config";
   4 â”‚ import {
   5 â”‚   PayMobAuthResponse,
   6 â”‚   PayMobOrderRequest,
   7 â”‚   PayMobOrderResponse,
   8 â”‚   PayMobPaymentKeyResponse,
   9 â”‚   PayMobBillingData,
  10 â”‚ } from "./types";
  11 â”‚ // Import utility functions from utils file
  12 â”‚ import {
  13 â”‚   formatAmountToCents as formatAmount,
  14 â”‚   generateMerchantOrderId,
  15 â”‚   createBillingData,
  16 â”‚ } from "./utils";
  17 â”‚ 
  18 â”‚ /**
  19 â”‚  * Step 1: Authenticates with PayMob to get an auth token.
  20 â”‚  * @returns A promise that resolves to the authentication token.
  21 â”‚  */
  22 â”‚ export async function authenticate(): Promise<string> {
  23 â”‚   try {
  24 â”‚     const controller = new AbortController();
  25 â”‚     const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 second timeout
  26 â”‚ 
  27 â”‚     const response = await fetch(`${paymobConfig.baseUrl}/auth/tokens`, {
  28 â”‚       method: "POST",
  29 â”‚       headers: {
  30 â”‚         "Content-Type": "application/json",
  31 â”‚       },
  32 â”‚       body: JSON.stringify({
  33 â”‚         api_key: paymobConfig.apiKey,
  34 â”‚       }),
  35 â”‚       signal: controller.signal,
  36 â”‚     });
  37 â”‚ 
  38 â”‚     clearTimeout(timeoutId);
  39 â”‚ 
  40 â”‚     if (!response.ok) {
  41 â”‚       throw new Error(`PayMob authentication failed: ${response.statusText}`);
  42 â”‚     }
  43 â”‚ 
  44 â”‚     const data: PayMobAuthResponse = await response.json();
  45 â”‚     return data.token;
  46 â”‚   } catch (error) {
  47 â”‚     console.error("PayMob authentication error:", error);
  48 â”‚     if (error instanceof Error && error.name === "AbortError") {
  49 â”‚       throw new Error(
  50 â”‚         "Ø§Ù†ØªÙ‡Øª Ù…Ù‡Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù†Ø¸Ø§Ù… Ø§Ù„Ø¯ÙØ¹. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰."
  51 â”‚       );
  52 â”‚     }
  53 â”‚     throw new Error("ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù†Ø¸Ø§Ù… Ø§Ù„Ø¯ÙØ¹");
  54 â”‚   }
  55 â”‚ }
  56 â”‚ 
  57 â”‚ /**
  58 â”‚  * Step 2: Creates an order with PayMob.
  59 â”‚  * @param authToken - The authentication token from Step 1.
  60 â”‚  * @param orderData - The data for the order.
  61 â”‚  * @returns A promise that resolves to the created order details.
  62 â”‚  */
  63 â”‚ export async function createOrder(
  64 â”‚   authToken: string,
  65 â”‚   orderData: PayMobOrderRequest
  66 â”‚ ): Promise<PayMobOrderResponse> {
  67 â”‚   try {
  68 â”‚     const controller = new AbortController();
  69 â”‚     const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 second timeout
  70 â”‚ 
  71 â”‚     const response = await fetch(`${paymobConfig.baseUrl}/ecommerce/orders`, {
  72 â”‚       method: "POST",
  73 â”‚       headers: {
  74 â”‚         "Content-Type": "application/json",
  75 â”‚       },
  76 â”‚       body: JSON.stringify({
  77 â”‚         auth_token: authToken,
  78 â”‚         delivery_needed: false, // Assuming this is always false for digital goods
  79 â”‚         ...orderData,
  80 â”‚       }),
  81 â”‚       signal: controller.signal,
  82 â”‚     });
  83 â”‚ 
  84 â”‚     clearTimeout(timeoutId);
  85 â”‚ 
  86 â”‚     if (!response.ok) {
  87 â”‚       const errorBody = await response.text();
  88 â”‚       console.error("PayMob order creation failed response:", errorBody);
  89 â”‚       throw new Error(`PayMob order creation failed: ${response.statusText}`);
  90 â”‚     }
  91 â”‚ 
  92 â”‚     const data: PayMobOrderResponse = await response.json();
  93 â”‚     return data;
  94 â”‚   } catch (error) {
  95 â”‚     console.error("PayMob order creation error:", error);
  96 â”‚     if (error instanceof Error && error.name === "AbortError") {
  97 â”‚       throw new Error("Ø§Ù†ØªÙ‡Øª Ù…Ù‡Ù„Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø·Ù„Ø¨ Ø§Ù„Ø¯ÙØ¹. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.");
  98 â”‚     }
  99 â”‚     throw new Error("ÙØ´Ù„ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø·Ù„Ø¨ Ø§Ù„Ø¯ÙØ¹");
 100 â”‚   }
 101 â”‚ }
 102 â”‚ 
 103 â”‚ /**
 104 â”‚  * Step 3: Gets a payment key for embedding the payment iframe.
 105 â”‚  * @param authToken - The authentication token.
 106 â”‚  * @param orderId - The ID of the order created in Step 2.
 107 â”‚  * @param amountCents - The total amount in cents.
 108 â”‚  * @param billingData - The customer's billing information.
 109 â”‚  * @param paymentMethod - The payment method to use ('credit-card' or 'e-wallet').
 110 â”‚  * @returns A promise that resolves to the payment key token.
 111 â”‚  */
 112 â”‚ export async function getPaymentKey(
 113 â”‚   authToken: string,
 114 â”‚   orderId: number,
 115 â”‚   amountCents: number,
 116 â”‚   billingData: PayMobBillingData,
 117 â”‚   paymentMethod: "credit-card" | "e-wallet" = "credit-card"
 118 â”‚ ): Promise<string> {
 119 â”‚   try {
 120 â”‚     // Select the appropriate integration ID based on payment method
 121 â”‚     let integrationId: number;
 122 â”‚     try {
 123 â”‚       integrationId =
 124 â”‚         paymentMethod === "e-wallet"
 125 â”‚           ? parseInt(paymobConfig.integrationIdMobileWallet)
 126 â”‚           : parseInt(paymobConfig.integrationIdOnlineCard);
 127 â”‚ 
 128 â”‚       if (isNaN(integrationId)) {
 129 â”‚         throw new Error(
 130 â”‚           `Invalid integration ID for payment method: ${paymentMethod}`
 131 â”‚         );
 132 â”‚       }
 133 â”‚     } catch (error) {
 134 â”‚       console.error("PayMob integration ID error:", error);
 135 â”‚       throw new Error(`ÙØ´Ù„ ÙÙŠ ØªÙƒÙˆÙŠÙ† Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹ ${paymentMethod}`);
 136 â”‚     }
 137 â”‚ 
 138 â”‚     console.log(
 139 â”‚       `Using integration ID ${integrationId} for payment method: ${paymentMethod}`
 140 â”‚     );
 141 â”‚ 
 142 â”‚     const controller = new AbortController();
 143 â”‚     const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 second timeout
 144 â”‚ 
 145 â”‚     const response = await fetch(
 146 â”‚       `${paymobConfig.baseUrl}/acceptance/payment_keys`,
 147 â”‚       {
 148 â”‚         method: "POST",
 149 â”‚         headers: {
 150 â”‚           "Content-Type": "application/json",
 151 â”‚         },
 152 â”‚         body: JSON.stringify({
 153 â”‚           auth_token: authToken,
 154 â”‚           amount_cents: amountCents,
 155 â”‚           expiration: paymobConfig.sessionExpiryMinutes * 60, // Dynamic expiration in seconds
 156 â”‚           order_id: orderId,
 157 â”‚           billing_data: billingData,
 158 â”‚           currency: "EGP",
 159 â”‚           integration_id: integrationId,
 160 â”‚           lock_order_when_paid: true,
 161 â”‚         }),
 162 â”‚         signal: controller.signal,
 163 â”‚       }
 164 â”‚     );
 165 â”‚ 
 166 â”‚     clearTimeout(timeoutId);
 167 â”‚ 
 168 â”‚     if (!response.ok) {
 169 â”‚       const errorBody = await response.text();
 170 â”‚       console.error("PayMob payment key failed response:", errorBody);
 171 â”‚       throw new Error(
 172 â”‚         `PayMob payment key generation failed: ${response.statusText}`
 173 â”‚       );
 174 â”‚     }
 175 â”‚ 
 176 â”‚     const data: PayMobPaymentKeyResponse = await response.json();
 177 â”‚     return data.token;
 178 â”‚   } catch (error) {
 179 â”‚     console.error("PayMob payment key error:", error);
 180 â”‚     if (error instanceof Error && error.name === "AbortError") {
 181 â”‚       throw new Error("Ø§Ù†ØªÙ‡Øª Ù…Ù‡Ù„Ø© Ø¥Ù†Ø´Ø§Ø¡ Ù…ÙØªØ§Ø­ Ø§Ù„Ø¯ÙØ¹. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.");
 182 â”‚     }
 183 â”‚     throw new Error("ÙØ´Ù„ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ù…ÙØªØ§Ø­ Ø§Ù„Ø¯ÙØ¹");
 184 â”‚   }
 185 â”‚ }
 186 â”‚ 
 187 â”‚ // Export a service object for backward compatibility
 188 â”‚ export const payMobService = {
 189 â”‚   authenticate,
 190 â”‚   createOrder,
 191 â”‚   getPaymentKey,
 192 â”‚   formatAmount,
 193 â”‚   generateMerchantOrderId,
 194 â”‚   createBillingData,
 195 â”‚   // Import webhook methods
 196 â”‚   async validateWebhookPayload(data: any) {
 197 â”‚     const { validateWebhookPayload } = await import("./webhook.service");
 198 â”‚     return validateWebhookPayload(data);
 199 â”‚   },
 200 â”‚   async verifyWebhookSignature(webhookObject: any) {
 201 â”‚     const { verifyWebhookSignature } = await import("./webhook.service");
 202 â”‚     return verifyWebhookSignature(webhookObject);
 203 â”‚   },
 204 â”‚   async processWebhook(webhookObject: any) {
 205 â”‚     const { processWebhook } = await import("./webhook.service");
 206 â”‚     return processWebhook(webhookObject);
 207 â”‚   },
 208 â”‚   async initiatePayment(
 209 â”‚     orderData: any,
 210 â”‚     courseId?: string,
 211 â”‚     paymentMethod: "credit-card" | "e-wallet" = "credit-card"
 212 â”‚   ) {
 213 â”‚     const { initiatePayment } = await import("./payment.service");
 214 â”‚     return initiatePayment(orderData, courseId, paymentMethod);
 215 â”‚   },
 216 â”‚ };
 217 â”‚ 

â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²
END OF FILE: client.ts
â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²


ğŸ“„ FILE: payment.service.ts
ğŸ“‚ PATH: src/lib/paymob/payment.service.ts
ğŸ“Š STATS: 81 lines | 2.54 KB
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ FILE CONTENT:                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   1 â”‚ // src/lib/paymob/payment.service.ts
   2 â”‚ 
   3 â”‚ import * as paymob from './client';
   4 â”‚ import { paymobConfig } from './config';
   5 â”‚ import { PayMobOrderRequest } from './types';
   6 â”‚ 
   7 â”‚ /**
   8 â”‚  * The response structure for a successful payment initiation.
   9 â”‚  */
  10 â”‚ export interface PaymentInitiationResult {
  11 â”‚   paymentKey: string;
  12 â”‚   orderId: number;
  13 â”‚   iframeUrl: string;
  14 â”‚ }
  15 â”‚ 
  16 â”‚ /**
  17 â”‚  * Orchestrates the complete PayMob payment flow:
  18 â”‚  * 1. Authenticates with PayMob.
  19 â”‚  * 2. Creates an order.
  20 â”‚  * 3. Generates a payment key for the iframe.
  21 â”‚  * @param orderData - The data required to create the order.
  22 â”‚  * @param courseId - The optional ID of the course for constructing the return URL.
  23 â”‚  * @param paymentMethod - The payment method to use ('credit-card' or 'e-wallet').
  24 â”‚  * @returns A promise that resolves to an object containing the payment key, order ID, and iframe URL.
  25 â”‚  */
  26 â”‚ export async function initiatePayment(
  27 â”‚   orderData: PayMobOrderRequest,
  28 â”‚   courseId?: string,
  29 â”‚   paymentMethod: 'credit-card' | 'e-wallet' = 'credit-card'
  30 â”‚ ): Promise<PaymentInitiationResult> {
  31 â”‚   try {
  32 â”‚     // Step 1: Authenticate
  33 â”‚     const authToken = await paymob.authenticate();
  34 â”‚ 
  35 â”‚     // Step 2: Create order
  36 â”‚     const order = await paymob.createOrder(authToken, orderData);
  37 â”‚ 
  38 â”‚     // Step 3: Get payment key
  39 â”‚     const paymentKey = await paymob.getPaymentKey(
  40 â”‚       authToken,
  41 â”‚       order.id,
  42 â”‚       orderData.amount_cents,
  43 â”‚       orderData.billing_data,
  44 â”‚       paymentMethod
  45 â”‚     );
  46 â”‚ 
  47 â”‚     // Step 4: Generate iframe URL
  48 â”‚     const iframeUrl = buildIframeUrl(paymentKey, courseId);
  49 â”‚ 
  50 â”‚     return {
  51 â”‚       paymentKey,
  52 â”‚       orderId: order.id,
  53 â”‚       iframeUrl,
  54 â”‚     };
  55 â”‚   } catch (error) {
  56 â”‚     console.error('PayMob payment initiation error:', error);
  57 â”‚     // Re-throw the original error to be handled by the calling function
  58 â”‚     throw error;
  59 â”‚   }
  60 â”‚ }
  61 â”‚ 
  62 â”‚ /**
  63 â”‚  * Constructs the PayMob iframe URL with an optional return URL.
  64 â”‚  * @param paymentKey - The payment token from PayMob.
  65 â”‚  * @param courseId - The optional course ID to embed in the return URL.
  66 â”‚  * @returns The fully constructed iframe URL.
  67 â”‚  */
  68 â”‚ function buildIframeUrl(paymentKey: string, courseId?: string): string {
  69 â”‚   let iframeUrl = `https://accept.paymob.com/api/acceptance/iframes/${paymobConfig.iframeId}?payment_token=${paymentKey}`;
  70 â”‚ 
  71 â”‚   // Add return URL if it's configured and a course ID is provided
  72 â”‚   if (paymobConfig.returnUrl && courseId) {
  73 â”‚     const returnUrlWithCourse = paymobConfig.returnUrl.replace(
  74 â”‚       '{courseId}',
  75 â”‚       courseId
  76 â”‚     );
  77 â”‚     iframeUrl += `&return_url=${encodeURIComponent(returnUrlWithCourse)}`;
  78 â”‚   }
  79 â”‚ 
  80 â”‚   return iframeUrl;
  81 â”‚ }

â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²
END OF FILE: payment.service.ts
â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²


ğŸ“„ FILE: webhook.service.ts
ğŸ“‚ PATH: src/lib/paymob/webhook.service.ts
ğŸ“Š STATS: 173 lines | 4.41 KB
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ FILE CONTENT:                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   1 â”‚ // src/lib/paymob/webhook.service.ts
   2 â”‚ 
   3 â”‚ import crypto from "crypto";
   4 â”‚ import { paymobConfig } from "./config";
   5 â”‚ import { PayMobTransactionResponse } from "./types";
   6 â”‚ 
   7 â”‚ /**
   8 â”‚  * Constant-time string comparison to prevent timing attacks.
   9 â”‚  */
  10 â”‚ function constantTimeCompare(a: string, b: string): boolean {
  11 â”‚   if (a.length !== b.length) {
  12 â”‚     return false;
  13 â”‚   }
  14 â”‚ 
  15 â”‚   let result = 0;
  16 â”‚   for (let i = 0; i < a.length; i++) {
  17 â”‚     result |= a.charCodeAt(i) ^ b.charCodeAt(i);
  18 â”‚   }
  19 â”‚ 
  20 â”‚   return result === 0;
  21 â”‚ }
  22 â”‚ 
  23 â”‚ /**
  24 â”‚  * Verifies the HMAC signature of a PayMob webhook payload.
  25 â”‚  * @param webhookObject - The full object received from the webhook `obj` key.
  26 â”‚  * @returns True if the signature is valid, otherwise false.
  27 â”‚  */
  28 â”‚ export function verifyWebhookSignature(
  29 â”‚   webhookObject: PayMobTransactionResponse
  30 â”‚ ): boolean {
  31 â”‚   try {
  32 â”‚     const { hmac, ...data } = webhookObject;
  33 â”‚ 
  34 â”‚     if (!hmac || typeof hmac !== "string") {
  35 â”‚       console.error("HMAC verification failed: Missing or invalid HMAC");
  36 â”‚       return false;
  37 â”‚     }
  38 â”‚ 
  39 â”‚     // The fields must be ordered alphabetically by key.
  40 â”‚     const orderedKeys = [
  41 â”‚       "amount_cents",
  42 â”‚       "created_at",
  43 â”‚       "currency",
  44 â”‚       "error_occured",
  45 â”‚       "has_parent_transaction",
  46 â”‚       "id",
  47 â”‚       "integration_id",
  48 â”‚       "is_3d_secure",
  49 â”‚       "is_auth",
  50 â”‚       "is_capture",
  51 â”‚       "is_refunded",
  52 â”‚       "is_standalone_payment",
  53 â”‚       "is_voided",
  54 â”‚       "order",
  55 â”‚       "owner",
  56 â”‚       "pending",
  57 â”‚       "source_data.pan",
  58 â”‚       "source_data.sub_type",
  59 â”‚       "source_data.type",
  60 â”‚       "success",
  61 â”‚     ];
  62 â”‚ 
  63 â”‚     // Build the concatenated string from the data object
  64 â”‚     const concatenatedString = orderedKeys
  65 â”‚       .map((key) => {
  66 â”‚         if (key.startsWith("source_data.")) {
  67 â”‚           const subKey = key.split(".")[1];
  68 â”‚           return (
  69 â”‚             data.source_data?.[subKey as keyof typeof data.source_data] ??
  70 â”‚             "false"
  71 â”‚           );
  72 â”‚         }
  73 â”‚         if (key === "order") {
  74 â”‚           return data.order?.id;
  75 â”‚         }
  76 â”‚         return data[key as keyof typeof data];
  77 â”‚       })
  78 â”‚       .join("");
  79 â”‚ 
  80 â”‚     // Generate our own HMAC
  81 â”‚     const calculatedHmac = crypto
  82 â”‚       .createHmac("sha512", paymobConfig.hmacSecret)
  83 â”‚       .update(concatenatedString)
  84 â”‚       .digest("hex");
  85 â”‚ 
  86 â”‚     // Compare safely
  87 â”‚     return constantTimeCompare(calculatedHmac, hmac);
  88 â”‚   } catch (error) {
  89 â”‚     console.error("HMAC verification error:", error);
  90 â”‚     return false;
  91 â”‚   }
  92 â”‚ }
  93 â”‚ 
  94 â”‚ /**
  95 â”‚  * Validates the structure of the incoming webhook payload.
  96 â”‚  * @param data - The full webhook data object.
  97 â”‚  * @returns True if the payload is valid, false otherwise.
  98 â”‚  */
  99 â”‚ export function validateWebhookPayload(
 100 â”‚   data: any
 101 â”‚ ): data is PayMobTransactionResponse {
 102 â”‚   if (!data || typeof data !== "object") return false;
 103 â”‚ 
 104 â”‚   const requiredFields = [
 105 â”‚     "id",
 106 â”‚     "amount_cents",
 107 â”‚     "success",
 108 â”‚     "pending",
 109 â”‚     "currency",
 110 â”‚     "integration_id",
 111 â”‚     "order",
 112 â”‚     "created_at",
 113 â”‚     "hmac",
 114 â”‚   ];
 115 â”‚ 
 116 â”‚   for (const field of requiredFields) {
 117 â”‚     if (!(field in data)) {
 118 â”‚       console.error(
 119 â”‚         `Webhook validation failed: Missing required field '${field}'`
 120 â”‚       );
 121 â”‚       return false;
 122 â”‚     }
 123 â”‚   }
 124 â”‚ 
 125 â”‚   if (!data.order || typeof data.order !== "object" || !("id" in data.order)) {
 126 â”‚     console.error(
 127 â”‚       "Webhook validation failed: Invalid or missing order object/ID"
 128 â”‚     );
 129 â”‚     return false;
 130 â”‚   }
 131 â”‚ 
 132 â”‚   return true;
 133 â”‚ }
 134 â”‚ 
 135 â”‚ /**
 136 â”‚  * A processed webhook response with a clear structure.
 137 â”‚  */
 138 â”‚ export interface ProcessedWebhook {
 139 â”‚   isValid: boolean;
 140 â”‚   transactionId?: number;
 141 â”‚   orderId?: number;
 142 â”‚   isSuccess?: boolean;
 143 â”‚   amountCents?: number;
 144 â”‚   currency?: string;
 145 â”‚   merchantOrderId?: string;
 146 â”‚ }
 147 â”‚ 
 148 â”‚ /**
 149 â”‚  * Processes the raw webhook data, including signature validation and data extraction.
 150 â”‚  * @param webhookObject - The `obj` from the webhook payload.
 151 â”‚  * @returns A structured object with the processing result.
 152 â”‚  */
 153 â”‚ export function processWebhook(webhookObject: unknown): ProcessedWebhook {
 154 â”‚   if (!validateWebhookPayload(webhookObject)) {
 155 â”‚     return { isValid: false };
 156 â”‚   }
 157 â”‚ 
 158 â”‚   const isValid = verifyWebhookSignature(webhookObject);
 159 â”‚   if (!isValid) {
 160 â”‚     return { isValid: false };
 161 â”‚   }
 162 â”‚ 
 163 â”‚   return {
 164 â”‚     isValid: true,
 165 â”‚     transactionId: webhookObject.id,
 166 â”‚     orderId: webhookObject.order.id,
 167 â”‚     isSuccess: webhookObject.success && !webhookObject.error_occured,
 168 â”‚     amountCents: webhookObject.amount_cents,
 169 â”‚     currency: webhookObject.currency,
 170 â”‚     merchantOrderId: webhookObject.order.merchant_order_id,
 171 â”‚   };
 172 â”‚ }
 173 â”‚ 

â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²
END OF FILE: webhook.service.ts
â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²


â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
ğŸ”¥ CORE PAYMENT SERVICES
â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ

â–¼ Payment Configuration & Types
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

ğŸ“„ FILE: config.ts
ğŸ“‚ PATH: src/lib/paymob/config.ts
ğŸ“Š STATS: 76 lines | 2.3 KB
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ FILE CONTENT:                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   1 â”‚ // src/lib/paymob/config.ts
   2 â”‚ 
   3 â”‚ import { PayMobConfig } from "./types";
   4 â”‚ 
   5 â”‚ /**
   6 â”‚  * Loads and validates the PayMob configuration from environment variables.
   7 â”‚  * Throws an error if critical configuration is missing.
   8 â”‚  */
   9 â”‚ function loadPayMobConfig(): PayMobConfig {
  10 â”‚   const config: PayMobConfig = {
  11 â”‚     apiKey: process.env.PAYMOB_API_KEY || "",
  12 â”‚     integrationIdOnlineCard:
  13 â”‚       process.env.PAYMOB_INTEGRATION_ID_ONLINE_CARD || "",
  14 â”‚     integrationIdMobileWallet:
  15 â”‚       process.env.PAYMOB_INTEGRATION_ID_MOBILE_WALLET || "",
  16 â”‚     iframeId: process.env.PAYMOB_IFRAME_ID || "",
  17 â”‚     hmacSecret: process.env.PAYMOB_HMAC_SECRET || "",
  18 â”‚     baseUrl: process.env.PAYMOB_BASE_URL || "https://accept.paymob.com/api",
  19 â”‚     webhookUrl: process.env.PAYMOB_WEBHOOK_URL || "",
  20 â”‚     returnUrl: process.env.PAYMOB_RETURN_URL || "", // â† This line was missing
  21 â”‚     // Payment session configuration
  22 â”‚     paymentTimeoutMinutes: parseInt(
  23 â”‚       process.env.PAYMOB_PAYMENT_TIMEOUT_MINUTES || "60"
  24 â”‚     ),
  25 â”‚     sessionExpiryMinutes: parseInt(
  26 â”‚       process.env.PAYMOB_SESSION_EXPIRY_MINUTES || "60"
  27 â”‚     ),
  28 â”‚     abandonedPaymentCleanupMinutes: parseInt(
  29 â”‚       process.env.PAYMOB_ABANDONED_CLEANUP_MINUTES || "30"
  30 â”‚     ),
  31 â”‚   };
  32 â”‚ 
  33 â”‚   const requiredFields = {
  34 â”‚     apiKey: "PAYMOB_API_KEY",
  35 â”‚     integrationIdOnlineCard: "PAYMOB_INTEGRATION_ID_ONLINE_CARD",
  36 â”‚     hmacSecret: "PAYMOB_HMAC_SECRET",
  37 â”‚     iframeId: "PAYMOB_IFRAME_ID",
  38 â”‚   };
  39 â”‚ 
  40 â”‚   const missingFields = [];
  41 â”‚   for (const [field, envVar] of Object.entries(requiredFields)) {
  42 â”‚     if (!config[field as keyof PayMobConfig]) {
  43 â”‚       missingFields.push(envVar);
  44 â”‚     }
  45 â”‚   }
  46 â”‚ 
  47 â”‚   // Validate integration IDs are numbers
  48 â”‚   if (
  49 â”‚     config.integrationIdOnlineCard &&
  50 â”‚     isNaN(parseInt(config.integrationIdOnlineCard))
  51 â”‚   ) {
  52 â”‚     missingFields.push("PAYMOB_INTEGRATION_ID_ONLINE_CARD (must be a number)");
  53 â”‚   }
  54 â”‚ 
  55 â”‚   if (
  56 â”‚     config.integrationIdMobileWallet &&
  57 â”‚     isNaN(parseInt(config.integrationIdMobileWallet))
  58 â”‚   ) {
  59 â”‚     console.warn(
  60 â”‚       "PAYMOB_INTEGRATION_ID_MOBILE_WALLET is not a valid number - mobile wallet payments will fail"
  61 â”‚     );
  62 â”‚   }
  63 â”‚ 
  64 â”‚   if (missingFields.length > 0) {
  65 â”‚     throw new Error(
  66 â”‚       `PayMob configuration is incomplete. Missing or invalid: ${missingFields.join(
  67 â”‚         ", "
  68 â”‚       )}`
  69 â”‚     );
  70 â”‚   }
  71 â”‚ 
  72 â”‚   return config;
  73 â”‚ }
  74 â”‚ 
  75 â”‚ export const paymobConfig = loadPayMobConfig();
  76 â”‚ 

â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²
END OF FILE: config.ts
â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²


ğŸ“„ FILE: types.ts
ğŸ“‚ PATH: src/lib/paymob/types.ts
ğŸ“Š STATS: 199 lines | 4.42 KB
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ FILE CONTENT:                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   1 â”‚ // src/lib/paymob/types.ts
   2 â”‚ 
   3 â”‚ export interface PayMobConfig {
   4 â”‚   apiKey: string;
   5 â”‚   integrationIdOnlineCard: string;
   6 â”‚   integrationIdMobileWallet: string;
   7 â”‚   iframeId: string;
   8 â”‚   hmacSecret: string;
   9 â”‚   baseUrl: string;
  10 â”‚   webhookUrl: string;
  11 â”‚   returnUrl: string;
  12 â”‚   // Payment timeout configuration
  13 â”‚   paymentTimeoutMinutes: number;
  14 â”‚   sessionExpiryMinutes: number;
  15 â”‚   abandonedPaymentCleanupMinutes: number;
  16 â”‚ }
  17 â”‚ 
  18 â”‚ export interface PayMobBillingData {
  19 â”‚   first_name: string;
  20 â”‚   last_name: string;
  21 â”‚   email: string;
  22 â”‚   phone_number: string;
  23 â”‚   country: string;
  24 â”‚   state: string;
  25 â”‚   city: string;
  26 â”‚   street: string;
  27 â”‚   building: string;
  28 â”‚   floor: string;
  29 â”‚   apartment: string;
  30 â”‚ }
  31 â”‚ 
  32 â”‚ export interface PayMobOrderItem {
  33 â”‚   name: string;
  34 â”‚   amount_cents: number;
  35 â”‚   description: string;
  36 â”‚   quantity: number;
  37 â”‚ }
  38 â”‚ 
  39 â”‚ export interface PayMobOrderRequest {
  40 â”‚   amount_cents: number;
  41 â”‚   currency: string;
  42 â”‚   merchant_order_id: string;
  43 â”‚   items: PayMobOrderItem[];
  44 â”‚   billing_data: PayMobBillingData;
  45 â”‚ }
  46 â”‚ 
  47 â”‚ export interface PayMobAuthResponse {
  48 â”‚   token: string;
  49 â”‚ }
  50 â”‚ 
  51 â”‚ export interface PayMobOrderResponse {
  52 â”‚   id: number;
  53 â”‚   created_at: string;
  54 â”‚   delivery_needed: boolean;
  55 â”‚   merchant: {
  56 â”‚     id: number;
  57 â”‚     created_at: string;
  58 â”‚     phones: string[];
  59 â”‚     company_emails: string[];
  60 â”‚     company_name: string;
  61 â”‚     state: string;
  62 â”‚     country: string;
  63 â”‚     city: string;
  64 â”‚     postal_code: string;
  65 â”‚     street: string;
  66 â”‚   };
  67 â”‚   collector: any;
  68 â”‚   amount_cents: number;
  69 â”‚   shipping_data: any;
  70 â”‚   currency: string;
  71 â”‚   is_payment_locked: boolean;
  72 â”‚   is_return: boolean;
  73 â”‚   is_cancel: boolean;
  74 â”‚   is_returned: boolean;
  75 â”‚   is_canceled: boolean;
  76 â”‚   merchant_order_id: string;
  77 â”‚   wallet_notification: any;
  78 â”‚   paid_amount_cents: number;
  79 â”‚   notify_user_with_email: boolean;
  80 â”‚   items: Array<{
  81 â”‚     name: string;
  82 â”‚     description: string;
  83 â”‚     amount_cents: number;
  84 â”‚     quantity: number;
  85 â”‚   }>;
  86 â”‚   order_url: string;
  87 â”‚   commission_fees: number;
  88 â”‚   delivery_fees_cents: number;
  89 â”‚   delivery_vat_cents: number;
  90 â”‚   payment_method: string;
  91 â”‚   merchant_staff_tag: any;
  92 â”‚   api_source: string;
  93 â”‚   data: any;
  94 â”‚ }
  95 â”‚ 
  96 â”‚ export interface PayMobPaymentKeyResponse {
  97 â”‚   token: string;
  98 â”‚ }
  99 â”‚ 
 100 â”‚ export interface PayMobTransactionResponse {
 101 â”‚   id: number;
 102 â”‚   pending: boolean;
 103 â”‚   amount_cents: number;
 104 â”‚   success: boolean;
 105 â”‚   is_auth: boolean;
 106 â”‚   is_capture: boolean;
 107 â”‚   is_standalone_payment: boolean;
 108 â”‚   is_voided: boolean;
 109 â”‚   is_refunded: boolean;
 110 â”‚   is_3d_secure: boolean;
 111 â”‚   integration_id: number;
 112 â”‚   profile_id: number;
 113 â”‚   has_parent_transaction: boolean;
 114 â”‚   order: {
 115 â”‚     id: number;
 116 â”‚     merchant_order_id: string;
 117 â”‚     amount_cents: number;
 118 â”‚     [key: string]: any;
 119 â”‚   };
 120 â”‚   created_at: string;
 121 â”‚   currency: string;
 122 â”‚   source_data: {
 123 â”‚     pan: string;
 124 â”‚     type: string;
 125 â”‚     tenure: any;
 126 â”‚     sub_type: string;
 127 â”‚   };
 128 â”‚   error_occured: boolean;
 129 â”‚   is_live: boolean;
 130 â”‚   refunded_amount_cents: number;
 131 â”‚   source_id: number;
 132 â”‚   is_captured: boolean;
 133 â”‚   captured_amount: number;
 134 â”‚   updated_at: string;
 135 â”‚   is_settled: boolean;
 136 â”‚   bill_balanced: boolean;
 137 â”‚   is_bill: boolean;
 138 â”‚   owner: number;
 139 â”‚   parent_transaction: any;
 140 â”‚   [key: string]: any; // For other potential fields
 141 â”‚ }
 142 â”‚ 
 143 â”‚ // Enhanced PayMob types for better type safety
 144 â”‚ 
 145 â”‚ export interface PayMobWebhookData {
 146 â”‚   type: 'TRANSACTION';
 147 â”‚   obj: PayMobTransactionResponse;
 148 â”‚ }
 149 â”‚ 
 150 â”‚ export interface PayMobApiError {
 151 â”‚   detail?: string;
 152 â”‚   message?: string;
 153 â”‚   errors?: Record<string, string[]>;
 154 â”‚   status_code?: number;
 155 â”‚ }
 156 â”‚ 
 157 â”‚ export interface PayMobPaymentSession {
 158 â”‚   paymentKey: string;
 159 â”‚   orderId: number;
 160 â”‚   iframeUrl: string;
 161 â”‚   expiresAt: Date;
 162 â”‚   merchantOrderId: string;
 163 â”‚ }
 164 â”‚ 
 165 â”‚ export interface PayMobWebhookProcessingResult {
 166 â”‚   success: boolean;
 167 â”‚   transactionId?: number;
 168 â”‚   orderId?: number;
 169 â”‚   isPaymentSuccess?: boolean;
 170 â”‚   amountCents?: number;
 171 â”‚   currency?: string;
 172 â”‚   merchantOrderId?: string;
 173 â”‚   error?: string;
 174 â”‚   requiresManualReview?: boolean;
 175 â”‚ }
 176 â”‚ 
 177 â”‚ // PayMob Configuration with validation
 178 â”‚ export interface ValidatedPayMobConfig extends PayMobConfig {
 179 â”‚   paymentTimeoutMinutes: number;
 180 â”‚   sessionExpiryMinutes: number;
 181 â”‚   abandonedPaymentCleanupMinutes: number;
 182 â”‚ }
 183 â”‚ 
 184 â”‚ // Billing data with validation helpers
 185 â”‚ export interface ValidatedBillingData extends PayMobBillingData {
 186 â”‚   isValid: boolean;
 187 â”‚   validationErrors?: string[];
 188 â”‚ }
 189 â”‚ 
 190 â”‚ // Enhanced order request with metadata
 191 â”‚ export interface EnhancedOrderRequest extends PayMobOrderRequest {
 192 â”‚   metadata?: {
 193 â”‚     courseId: string;
 194 â”‚     userId: string;
 195 â”‚     paymentMethod: 'credit-card' | 'e-wallet';
 196 â”‚     initiatedAt: string;
 197 â”‚   };
 198 â”‚ }
 199 â”‚ 

â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²
END OF FILE: types.ts
â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²


ğŸ“„ FILE: webhook-processor.ts
ğŸ“‚ PATH: src/lib/webhook-processor.ts
ğŸ“Š STATS: 135 lines | 3.42 KB
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ FILE CONTENT:                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   1 â”‚ // src/lib/webhook-processor.ts
   2 â”‚ import prisma from "@/lib/prisma";
   3 â”‚ import crypto from "crypto";
   4 â”‚ 
   5 â”‚ export interface WebhookPayload {
   6 â”‚   type: string;
   7 â”‚   obj: {
   8 â”‚     id: string;
   9 â”‚     amount_cents: number;
  10 â”‚     currency: string;
  11 â”‚     success: boolean;
  12 â”‚     pending?: boolean;
  13 â”‚     refunded?: boolean;
  14 â”‚     order?: {
  15 â”‚       merchant_order_id: string;
  16 â”‚     };
  17 â”‚     source_data?: {
  18 â”‚       type: string;
  19 â”‚       pan?: string;
  20 â”‚     };
  21 â”‚   };
  22 â”‚ }
  23 â”‚ 
  24 â”‚ export async function processWebhookPayload(
  25 â”‚   payload: any,
  26 â”‚   signature: string
  27 â”‚ ): Promise<void> {
  28 â”‚   // Verify signature
  29 â”‚   const hmacSecret = process.env.PAYMOB_HMAC_SECRET;
  30 â”‚   if (!hmacSecret) {
  31 â”‚     throw new Error("PAYMOB_HMAC_SECRET not configured");
  32 â”‚   }
  33 â”‚ 
  34 â”‚   const expectedSignature = crypto
  35 â”‚     .createHmac("sha512", hmacSecret)
  36 â”‚     .update(JSON.stringify(payload))
  37 â”‚     .digest("hex");
  38 â”‚ 
  39 â”‚   if (signature !== expectedSignature) {
  40 â”‚     throw new Error("Invalid webhook signature");
  41 â”‚   }
  42 â”‚ 
  43 â”‚   // Validate payload structure
  44 â”‚   if (!payload.type || !payload.obj) {
  45 â”‚     throw new Error("Invalid webhook payload structure");
  46 â”‚   }
  47 â”‚ 
  48 â”‚   if (payload.type !== "TRANSACTION") {
  49 â”‚     // Ignore non-transaction webhooks
  50 â”‚     return;
  51 â”‚   }
  52 â”‚ 
  53 â”‚   const transaction = payload.obj;
  54 â”‚ 
  55 â”‚   if (!transaction.id || !transaction.order?.merchant_order_id) {
  56 â”‚     throw new Error("Missing required transaction data");
  57 â”‚   }
  58 â”‚ 
  59 â”‚   const paymentId = transaction.order.merchant_order_id;
  60 â”‚ 
  61 â”‚   // Find the payment
  62 â”‚   const payment = await prisma.payment.findUnique({
  63 â”‚     where: { id: paymentId },
  64 â”‚     include: {
  65 â”‚       user: true,
  66 â”‚       course: true,
  67 â”‚     },
  68 â”‚   });
  69 â”‚ 
  70 â”‚   if (!payment) {
  71 â”‚     throw new Error(`Payment not found: ${paymentId}`);
  72 â”‚   }
  73 â”‚ 
  74 â”‚   // Determine payment status based on transaction data
  75 â”‚   let newStatus: string;
  76 â”‚   let failureReason: string | null = null;
  77 â”‚ 
  78 â”‚   if (transaction.success && !transaction.pending && !transaction.refunded) {
  79 â”‚     newStatus = "COMPLETED";
  80 â”‚   } else if (transaction.pending) {
  81 â”‚     newStatus = "PROCESSING";
  82 â”‚   } else if (transaction.refunded) {
  83 â”‚     newStatus = "REFUNDED";
  84 â”‚   } else {
  85 â”‚     newStatus = "FAILED";
  86 â”‚     failureReason = "Payment failed at PayMob";
  87 â”‚   }
  88 â”‚ 
  89 â”‚   // Update payment
  90 â”‚   const updatedPayment = await prisma.payment.update({
  91 â”‚     where: { id: paymentId },
  92 â”‚     data: {
  93 â”‚       status: newStatus as any,
  94 â”‚       paymobTransactionId: transaction.id,
  95 â”‚       paymentMethod: transaction.source_data?.type?.toUpperCase() || "CARD",
  96 â”‚       failureReason,
  97 â”‚       updatedAt: new Date(),
  98 â”‚     },
  99 â”‚   });
 100 â”‚ 
 101 â”‚   // Handle enrollment creation for completed payments
 102 â”‚   if (newStatus === "COMPLETED" && payment.status !== "COMPLETED") {
 103 â”‚     try {
 104 â”‚       // Check if enrollment already exists
 105 â”‚       const existingEnrollment = await prisma.enrollment.findFirst({
 106 â”‚         where: {
 107 â”‚           userId: payment.userId,
 108 â”‚           courseId: payment.courseId,
 109 â”‚         },
 110 â”‚       });
 111 â”‚ 
 112 â”‚       if (!existingEnrollment) {
 113 â”‚         await prisma.enrollment.create({
 114 â”‚           data: {
 115 â”‚             userId: payment.userId,
 116 â”‚             courseId: payment.courseId,
 117 â”‚           },
 118 â”‚         });
 119 â”‚ 
 120 â”‚         // Course enrollment count is calculated via _count.enrollments
 121 â”‚       }
 122 â”‚     } catch (enrollmentError) {
 123 â”‚       console.error(
 124 â”‚         "Failed to create enrollment during webhook processing:",
 125 â”‚         enrollmentError
 126 â”‚       );
 127 â”‚       // Don't throw error as payment was processed successfully
 128 â”‚     }
 129 â”‚   }
 130 â”‚ 
 131 â”‚   console.log(
 132 â”‚     `Webhook processed successfully for payment ${paymentId}: ${payment.status} -> ${newStatus}`
 133 â”‚   );
 134 â”‚ }
 135 â”‚ 

â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²
END OF FILE: webhook-processor.ts
â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²


â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
ğŸ“š CORE ENROLLMENT SERVICES
â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ

â–¼ Enrollment Processing Core
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

ğŸ“„ FILE: core.service.ts
ğŸ“‚ PATH: src/lib/services/enrollment/core.service.ts
ğŸ“Š STATS: 200 lines | 5.89 KB
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ FILE CONTENT:                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   1 â”‚ // src/lib/services/enrollment/core.service.ts
   2 â”‚ 
   3 â”‚ import prisma from '@/lib/prisma';
   4 â”‚ import { EnrollmentResult } from './types';
   5 â”‚ // Import webhook service functions
   6 â”‚ import { 
   7 â”‚   createEnrollmentFromPayment as createEnrollmentFromPaymentWebhook,
   8 â”‚   handleEnrollmentFailure as handleEnrollmentFailureWebhook
   9 â”‚ } from './webhook.service';
  10 â”‚ 
  11 â”‚ /**
  12 â”‚  * Enroll a user in a free course.
  13 â”‚  * @param courseId - The ID of the free course.
  14 â”‚  * @param userId - The ID of the user to enroll.
  15 â”‚  * @returns A promise that resolves to an EnrollmentResult object.
  16 â”‚  */
  17 â”‚ export async function enrollInFreeCourse(
  18 â”‚   courseId: string,
  19 â”‚   userId: string
  20 â”‚ ): Promise<EnrollmentResult> {
  21 â”‚   try {
  22 â”‚     const user = await prisma.user.findUnique({ where: { id: userId } });
  23 â”‚     if (!user || user.role !== 'STUDENT') {
  24 â”‚       return { success: false, message: 'ØºÙŠØ± Ù…ØµØ±Ø­ Ù„Ùƒ Ø¨Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙÙŠ Ø§Ù„Ø¯ÙˆØ±Ø§Øª' };
  25 â”‚     }
  26 â”‚ 
  27 â”‚     const course = await prisma.course.findUnique({
  28 â”‚       where: { id: courseId },
  29 â”‚       select: { isPublished: true, price: true, professorId: true },
  30 â”‚     });
  31 â”‚ 
  32 â”‚     if (!course) {
  33 â”‚       return { success: false, message: 'Ø§Ù„Ø¯ÙˆØ±Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©' };
  34 â”‚     }
  35 â”‚     if (!course.isPublished) {
  36 â”‚       return { success: false, message: 'Ø§Ù„Ø¯ÙˆØ±Ø© ØºÙŠØ± Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹' };
  37 â”‚     }
  38 â”‚     if (course.professorId === userId) {
  39 â”‚       return { success: false, message: 'Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙÙŠ Ø¯ÙˆØ±ØªÙƒ Ø§Ù„Ø®Ø§ØµØ©' };
  40 â”‚     }
  41 â”‚     if (course.price && Number(course.price) > 0) {
  42 â”‚       return {
  43 â”‚         success: false,
  44 â”‚         message: 'Ù‡Ø°Ù‡ Ø§Ù„Ø¯ÙˆØ±Ø© Ù…Ø¯ÙÙˆØ¹Ø© ÙˆØªØªØ·Ù„Ø¨ Ø¯ÙØ¹',
  45 â”‚         requiresPayment: true,
  46 â”‚       };
  47 â”‚     }
  48 â”‚ 
  49 â”‚     const existingEnrollment = await prisma.enrollment.findUnique({
  50 â”‚       where: { userId_courseId: { userId, courseId } },
  51 â”‚     });
  52 â”‚ 
  53 â”‚     if (existingEnrollment) {
  54 â”‚       return {
  55 â”‚         success: false,
  56 â”‚         message: 'Ø£Ù†Øª Ù…Ø³Ø¬Ù„ Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ø¯ÙˆØ±Ø©',
  57 â”‚         enrollmentId: existingEnrollment.id,
  58 â”‚       };
  59 â”‚     }
  60 â”‚ 
  61 â”‚     const enrollment = await prisma.enrollment.create({
  62 â”‚       data: {
  63 â”‚         userId,
  64 â”‚         courseId,
  65 â”‚         enrolledAt: new Date(),
  66 â”‚         progressPercent: 0,
  67 â”‚         completedLessonIds: [],
  68 â”‚         totalWatchTime: 0,
  69 â”‚       },
  70 â”‚     });
  71 â”‚ 
  72 â”‚     return {
  73 â”‚       success: true,
  74 â”‚       message: 'ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙÙŠ Ø§Ù„Ø¯ÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­',
  75 â”‚       enrollmentId: enrollment.id,
  76 â”‚     };
  77 â”‚   } catch (error) {
  78 â”‚     console.error('Error enrolling in free course:', error);
  79 â”‚     return {
  80 â”‚       success: false,
  81 â”‚       message: 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ³Ø¬ÙŠÙ„',
  82 â”‚       error: error instanceof Error ? error.message : 'Unknown error',
  83 â”‚     };
  84 â”‚   }
  85 â”‚ }
  86 â”‚ 
  87 â”‚ /**
  88 â”‚  * Create an enrollment record after a successful payment has been verified.
  89 â”‚  * @param courseId - The ID of the course.
  90 â”‚  * @param userId - The ID of the user.
  91 â”‚  * @param paymentId - The ID of the completed payment record.
  92 â”‚  * @returns A promise that resolves to an EnrollmentResult object.
  93 â”‚  */
  94 â”‚ export async function createPaidEnrollment(
  95 â”‚   courseId: string,
  96 â”‚   userId: string,
  97 â”‚   paymentId: string
  98 â”‚ ): Promise<EnrollmentResult> {
  99 â”‚   try {
 100 â”‚     // Verify payment exists and is completed
 101 â”‚     const payment = await prisma.payment.findUnique({
 102 â”‚       where: { id: paymentId },
 103 â”‚       include: { course: true },
 104 â”‚     });
 105 â”‚ 
 106 â”‚     if (!payment) {
 107 â”‚       return {
 108 â”‚         success: false,
 109 â”‚         message: 'Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¯ÙØ¹ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©',
 110 â”‚       };
 111 â”‚     }
 112 â”‚ 
 113 â”‚     if (payment.status !== 'COMPLETED') {
 114 â”‚       return {
 115 â”‚         success: false,
 116 â”‚         message: 'Ø§Ù„Ø¯ÙØ¹ Ù„Ù… ÙŠÙƒØªÙ…Ù„ Ø¨Ø¹Ø¯',
 117 â”‚       };
 118 â”‚     }
 119 â”‚ 
 120 â”‚     if (payment.courseId !== courseId || payment.userId !== userId) {
 121 â”‚       return {
 122 â”‚         success: false,
 123 â”‚         message: 'Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯ÙØ¹ ØºÙŠØ± Ù…ØªØ·Ø§Ø¨Ù‚Ø©',
 124 â”‚       };
 125 â”‚     }
 126 â”‚ 
 127 â”‚     // Check if already enrolled
 128 â”‚     const existingEnrollment = await prisma.enrollment.findUnique({
 129 â”‚       where: {
 130 â”‚         userId_courseId: {
 131 â”‚           userId,
 132 â”‚           courseId,
 133 â”‚         },
 134 â”‚       },
 135 â”‚     });
 136 â”‚ 
 137 â”‚     if (existingEnrollment) {
 138 â”‚       return {
 139 â”‚         success: true,
 140 â”‚         message: 'Ø£Ù†Øª Ù…Ø³Ø¬Ù„ Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ø¯ÙˆØ±Ø©',
 141 â”‚         enrollmentId: existingEnrollment.id,
 142 â”‚       };
 143 â”‚     }
 144 â”‚ 
 145 â”‚     // Create enrollment
 146 â”‚     const enrollment = await prisma.enrollment.create({
 147 â”‚       data: {
 148 â”‚         userId,
 149 â”‚         courseId,
 150 â”‚         enrolledAt: new Date(),
 151 â”‚       },
 152 â”‚     });
 153 â”‚ 
 154 â”‚     return {
 155 â”‚       success: true,
 156 â”‚       message: 'ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙÙŠ Ø§Ù„Ø¯ÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­ Ø¨Ø¹Ø¯ Ø§Ù„Ø¯ÙØ¹',
 157 â”‚       enrollmentId: enrollment.id,
 158 â”‚     };
 159 â”‚   } catch (error) {
 160 â”‚     console.error('Error creating paid enrollment:', error);
 161 â”‚     return {
 162 â”‚       success: false,
 163 â”‚       message: 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªØ³Ø¬ÙŠÙ„',
 164 â”‚       error: error instanceof Error ? error.message : 'Unknown error',
 165 â”‚     };
 166 â”‚   }
 167 â”‚ }
 168 â”‚ 
 169 â”‚ // Export a service class for backward compatibility
 170 â”‚ export class EnrollmentService {
 171 â”‚   static async enrollInFreeCourse(courseId: string, userId: string) {
 172 â”‚     return enrollInFreeCourse(courseId, userId);
 173 â”‚   }
 174 â”‚ 
 175 â”‚   static async createPaidEnrollment(courseId: string, userId: string, paymentId: string) {
 176 â”‚     return createPaidEnrollment(courseId, userId, paymentId);
 177 â”‚   }
 178 â”‚ 
 179 â”‚   static async checkCourseAccess(courseId: string, userId?: string, userRole?: any) {
 180 â”‚     // Import and use the access service
 181 â”‚     const { checkCourseAccess } = await import('../enrollment/access.service');
 182 â”‚     return checkCourseAccess(courseId, userId, userRole);
 183 â”‚   }
 184 â”‚ 
 185 â”‚   static async createEnrollmentFromPayment(paymentData: {
 186 â”‚     courseId: string;
 187 â”‚     userId: string;
 188 â”‚     paymentId: string;
 189 â”‚   }) {
 190 â”‚     return createEnrollmentFromPaymentWebhook(paymentData.paymentId);
 191 â”‚   }
 192 â”‚ 
 193 â”‚   static async handleEnrollmentFailure(paymentId: string, reason: string) {
 194 â”‚     await handleEnrollmentFailureWebhook(paymentId, reason);
 195 â”‚     return {
 196 â”‚       success: false,
 197 â”‚       message: `ÙØ´Ù„ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªØ³Ø¬ÙŠÙ„: ${reason}`,
 198 â”‚     };
 199 â”‚   }
 200 â”‚ }

â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²
END OF FILE: core.service.ts
â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²


ğŸ“„ FILE: route.ts
ğŸ“‚ PATH: src/app/api/courses/[id]/enroll/route.ts
ğŸ“Š STATS: 221 lines | 5.81 KB
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ FILE CONTENT:                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   1 â”‚ // src/app/api/courses/[id]/enroll/route.ts
   2 â”‚ import { NextRequest} from 'next/server';
   3 â”‚ import { auth } from '@/lib/auth';
   4 â”‚ import prisma from '@/lib/prisma';
   5 â”‚ import { createSuccessResponse, createErrorResponse, ApiErrors } from '@/lib/api-utils';
   6 â”‚ 
   7 â”‚ interface RouteParams {
   8 â”‚   params: { id: string }
   9 â”‚ }
  10 â”‚ 
  11 â”‚ // POST /api/courses/[id]/enroll - Enroll in course
  12 â”‚ export async function POST(request: NextRequest, { params }: RouteParams) {
  13 â”‚   try {
  14 â”‚     const session = await auth();
  15 â”‚     
  16 â”‚     // Check authentication
  17 â”‚     if (!session?.user) {
  18 â”‚       return createErrorResponse(
  19 â”‚         ApiErrors.UNAUTHORIZED.code,
  20 â”‚         ApiErrors.UNAUTHORIZED.message,
  21 â”‚         ApiErrors.UNAUTHORIZED.status
  22 â”‚       );
  23 â”‚     }
  24 â”‚ 
  25 â”‚     // Only students can enroll (admins can enroll for testing)
  26 â”‚     if (!['STUDENT', 'ADMIN'].includes(session.user.role)) {
  27 â”‚       return createErrorResponse(
  28 â”‚         ApiErrors.FORBIDDEN.code,
  29 â”‚         'ØºÙŠØ± Ù…ØµØ±Ø­ Ù„Ùƒ Ø¨Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙÙŠ Ø§Ù„Ø¯ÙˆØ±Ø§Øª',
  30 â”‚         ApiErrors.FORBIDDEN.status
  31 â”‚       );
  32 â”‚     }
  33 â”‚ 
  34 â”‚     const { id: courseId } = await params;
  35 â”‚ 
  36 â”‚     // Check if course exists and is published
  37 â”‚     const course = await prisma.course.findFirst({
  38 â”‚       where: { 
  39 â”‚         id: courseId, 
  40 â”‚         isPublished: true 
  41 â”‚       },
  42 â”‚       select: {
  43 â”‚         id: true,
  44 â”‚         title: true,
  45 â”‚         price: true,
  46 â”‚         currency: true,
  47 â”‚         professorId: true
  48 â”‚       }
  49 â”‚     });
  50 â”‚ 
  51 â”‚     if (!course) {
  52 â”‚       return createErrorResponse(
  53 â”‚         ApiErrors.NOT_FOUND.code,
  54 â”‚         'Ø§Ù„Ø¯ÙˆØ±Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø© Ø£Ùˆ ØºÙŠØ± Ù…Ù†Ø´ÙˆØ±Ø©',
  55 â”‚         ApiErrors.NOT_FOUND.status
  56 â”‚       );
  57 â”‚     }
  58 â”‚ 
  59 â”‚     // Check if user is already enrolled
  60 â”‚     const existingEnrollment = await prisma.enrollment.findUnique({
  61 â”‚       where: {
  62 â”‚         userId_courseId: {
  63 â”‚           userId: session.user.id,
  64 â”‚           courseId
  65 â”‚         }
  66 â”‚       }
  67 â”‚     });
  68 â”‚ 
  69 â”‚     if (existingEnrollment) {
  70 â”‚       return createErrorResponse(
  71 â”‚         ApiErrors.DUPLICATE_ERROR.code,
  72 â”‚         'Ø£Ù†Øª Ù…Ø³Ø¬Ù„ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ø¯ÙˆØ±Ø© Ø¨Ø§Ù„ÙØ¹Ù„',
  73 â”‚         ApiErrors.DUPLICATE_ERROR.status
  74 â”‚       );
  75 â”‚     }
  76 â”‚ 
  77 â”‚     // Check if course is paid and requires payment
  78 â”‚     if (course.price && Number(course.price) > 0) {
  79 â”‚       // For paid courses, check if there's a completed payment
  80 â”‚       const completedPayment = await prisma.payment.findFirst({
  81 â”‚         where: {
  82 â”‚           userId: session.user.id,
  83 â”‚           courseId,
  84 â”‚           status: 'COMPLETED'
  85 â”‚         }
  86 â”‚       });
  87 â”‚ 
  88 â”‚       if (!completedPayment) {
  89 â”‚         return createErrorResponse(
  90 â”‚           'PAYMENT_REQUIRED',
  91 â”‚           'Ù‡Ø°Ù‡ Ø¯ÙˆØ±Ø© Ù…Ø¯ÙÙˆØ¹Ø©. ÙŠØ¬Ø¨ Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø¯ÙØ¹ Ø£ÙˆÙ„Ø§Ù‹.',
  92 â”‚           402 // Payment Required
  93 â”‚         );
  94 â”‚       }
  95 â”‚     }
  96 â”‚ 
  97 â”‚     // Prevent professors from enrolling in their own courses
  98 â”‚     if (course.professorId === session.user.id) {
  99 â”‚       return createErrorResponse(
 100 â”‚         'INVALID_ENROLLMENT',
 101 â”‚         'Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙÙŠ Ø¯ÙˆØ±ØªÙƒ Ø§Ù„Ø®Ø§ØµØ©',
 102 â”‚         400
 103 â”‚       );
 104 â”‚     }
 105 â”‚ 
 106 â”‚     // Create enrollment for free courses
 107 â”‚     const enrollment = await prisma.enrollment.create({
 108 â”‚       data: {
 109 â”‚         userId: session.user.id,
 110 â”‚         courseId,
 111 â”‚         progressPercent: 0,
 112 â”‚         completedLessonIds: [],
 113 â”‚         totalWatchTime: 0
 114 â”‚       },
 115 â”‚       include: {
 116 â”‚         course: {
 117 â”‚           select: {
 118 â”‚             id: true,
 119 â”‚             title: true,
 120 â”‚             thumbnailUrl: true,
 121 â”‚             professor: {
 122 â”‚               select: {
 123 â”‚                 name: true
 124 â”‚               }
 125 â”‚             }
 126 â”‚           }
 127 â”‚         }
 128 â”‚       }
 129 â”‚     });
 130 â”‚ 
 131 â”‚     return createSuccessResponse({
 132 â”‚       enrollment,
 133 â”‚       message: 'ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙÙŠ Ø§Ù„Ø¯ÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­!'
 134 â”‚     }, 201);
 135 â”‚ 
 136 â”‚   } catch (error) {
 137 â”‚     console.error('Course enrollment error:', error);
 138 â”‚     return createErrorResponse(
 139 â”‚       ApiErrors.INTERNAL_ERROR.code,
 140 â”‚       ApiErrors.INTERNAL_ERROR.message,
 141 â”‚       ApiErrors.INTERNAL_ERROR.status,
 142 â”‚       error
 143 â”‚     );
 144 â”‚   }
 145 â”‚ }
 146 â”‚ 
 147 â”‚ // DELETE /api/courses/[id]/enroll - Unenroll from course
 148 â”‚ export async function DELETE(request: NextRequest, { params }: RouteParams) {
 149 â”‚   try {
 150 â”‚     const session = await auth();
 151 â”‚     
 152 â”‚     // Check authentication
 153 â”‚     if (!session?.user) {
 154 â”‚       return createErrorResponse(
 155 â”‚         ApiErrors.UNAUTHORIZED.code,
 156 â”‚         ApiErrors.UNAUTHORIZED.message,
 157 â”‚         ApiErrors.UNAUTHORIZED.status
 158 â”‚       );
 159 â”‚     }
 160 â”‚ 
 161 â”‚     const { id: courseId } = params;
 162 â”‚ 
 163 â”‚     // Check if enrollment exists
 164 â”‚     const enrollment = await prisma.enrollment.findUnique({
 165 â”‚       where: {
 166 â”‚         userId_courseId: {
 167 â”‚           userId: session.user.id,
 168 â”‚           courseId
 169 â”‚         }
 170 â”‚       },
 171 â”‚       include: {
 172 â”‚         course: {
 173 â”‚           select: {
 174 â”‚             title: true,
 175 â”‚             price: true
 176 â”‚           }
 177 â”‚         }
 178 â”‚       }
 179 â”‚     });
 180 â”‚ 
 181 â”‚     if (!enrollment) {
 182 â”‚       return createErrorResponse(
 183 â”‚         ApiErrors.NOT_FOUND.code,
 184 â”‚         'Ø£Ù†Øª ØºÙŠØ± Ù…Ø³Ø¬Ù„ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ø¯ÙˆØ±Ø©',
 185 â”‚         ApiErrors.NOT_FOUND.status
 186 â”‚       );
 187 â”‚     }
 188 â”‚ 
 189 â”‚     // Prevent unenrollment from paid courses (business rule)
 190 â”‚     if (enrollment.course.price && Number(enrollment.course.price) > 0) {
 191 â”‚       return createErrorResponse(
 192 â”‚         'PAID_COURSE_UNENROLL',
 193 â”‚         'Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ù…Ù† Ø§Ù„Ø¯ÙˆØ±Ø§Øª Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø©. ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ.',
 194 â”‚         400
 195 â”‚       );
 196 â”‚     }
 197 â”‚ 
 198 â”‚     // Delete enrollment
 199 â”‚     await prisma.enrollment.delete({
 200 â”‚       where: {
 201 â”‚         userId_courseId: {
 202 â”‚           userId: session.user.id,
 203 â”‚           courseId
 204 â”‚         }
 205 â”‚       }
 206 â”‚     });
 207 â”‚ 
 208 â”‚     return createSuccessResponse({
 209 â”‚       message: 'ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ù…Ù† Ø§Ù„Ø¯ÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­'
 210 â”‚     });
 211 â”‚ 
 212 â”‚   } catch (error) {
 213 â”‚     console.error('Course unenrollment error:', error);
 214 â”‚     return createErrorResponse(
 215 â”‚       ApiErrors.INTERNAL_ERROR.code,
 216 â”‚       ApiErrors.INTERNAL_ERROR.message,
 217 â”‚       ApiErrors.INTERNAL_ERROR.status,
 218 â”‚       error
 219 â”‚     );
 220 â”‚   }
 221 â”‚ }

â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²
END OF FILE: route.ts
â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²


ğŸ“„ FILE: route.ts
ğŸ“‚ PATH: src/app/api/courses/[id]/enroll-enhanced/route.ts
ğŸ“Š STATS: 166 lines | 4.37 KB
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ FILE CONTENT:                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   1 â”‚ // src/app/api/courses/[id]/enroll-enhanced/route.ts
   2 â”‚ // Enhanced enrollment API with payment integration
   3 â”‚ 
   4 â”‚ import { NextRequest, NextResponse } from 'next/server';
   5 â”‚ import { auth } from '@/lib/auth';
   6 â”‚ import { EnrollmentService } from '@/lib/services/enrollment/core.service';
   7 â”‚ import { z } from 'zod';
   8 â”‚ 
   9 â”‚ const enrollmentSchema = z.object({
  10 â”‚   paymentId: z.string().optional(), // For paid courses
  11 â”‚   enrollmentType: z.enum(['free', 'paid']).default('free')
  12 â”‚ });
  13 â”‚ 
  14 â”‚ export async function POST(
  15 â”‚   request: NextRequest,
  16 â”‚   { params }: { params: { id: string } }
  17 â”‚ ) {
  18 â”‚   try {
  19 â”‚     const session = await auth();
  20 â”‚     
  21 â”‚     if (!session?.user?.id) {
  22 â”‚       return NextResponse.json(
  23 â”‚         { error: 'ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹', code: 'UNAUTHORIZED' },
  24 â”‚         { status: 401 }
  25 â”‚       );
  26 â”‚     }
  27 â”‚ 
  28 â”‚     if (session.user.role !== 'STUDENT') {
  29 â”‚       return NextResponse.json(
  30 â”‚         { error: 'Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ù…ØªØ§Ø­ Ù„Ù„Ø·Ù„Ø§Ø¨ ÙÙ‚Ø·', code: 'FORBIDDEN' },
  31 â”‚         { status: 403 }
  32 â”‚       );
  33 â”‚     }
  34 â”‚ 
  35 â”‚     const courseId = params.id;
  36 â”‚     const body = await request.json();
  37 â”‚     const { paymentId, enrollmentType } = enrollmentSchema.parse(body);
  38 â”‚ 
  39 â”‚     // Check course access first
  40 â”‚     const accessResult = await EnrollmentService.checkCourseAccess(
  41 â”‚       courseId,
  42 â”‚       session.user.id,
  43 â”‚       session.user.role
  44 â”‚     );
  45 â”‚ 
  46 â”‚     if (accessResult.hasAccess) {
  47 â”‚       return NextResponse.json({
  48 â”‚         success: true,
  49 â”‚         message: 'Ø£Ù†Øª Ù…Ø³Ø¬Ù„ Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ø¯ÙˆØ±Ø©',
  50 â”‚         enrollment: accessResult.enrollment
  51 â”‚       });
  52 â”‚     }
  53 â”‚ 
  54 â”‚     if (!accessResult.canEnroll) {
  55 â”‚       return NextResponse.json(
  56 â”‚         { 
  57 â”‚           error: accessResult.message,
  58 â”‚           code: 'CANNOT_ENROLL'
  59 â”‚         },
  60 â”‚         { status: 400 }
  61 â”‚       );
  62 â”‚     }
  63 â”‚ 
  64 â”‚     let enrollmentResult;
  65 â”‚ 
  66 â”‚     if (enrollmentType === 'free' || !accessResult.requiresPayment) {
  67 â”‚       // Free enrollment
  68 â”‚       enrollmentResult = await EnrollmentService.enrollInFreeCourse(
  69 â”‚         courseId,
  70 â”‚         session.user.id
  71 â”‚       );
  72 â”‚     } else if (enrollmentType === 'paid' && paymentId) {
  73 â”‚       // Paid enrollment - verify payment first
  74 â”‚       enrollmentResult = await EnrollmentService.createPaidEnrollment(
  75 â”‚         courseId,
  76 â”‚         session.user.id,
  77 â”‚         paymentId
  78 â”‚       );
  79 â”‚     } else {
  80 â”‚       return NextResponse.json(
  81 â”‚         { 
  82 â”‚           error: 'Ù‡Ø°Ù‡ Ø§Ù„Ø¯ÙˆØ±Ø© Ù…Ø¯ÙÙˆØ¹Ø© ÙˆØªØªØ·Ù„Ø¨ Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø¯ÙØ¹ Ø£ÙˆÙ„Ø§Ù‹',
  83 â”‚           code: 'PAYMENT_REQUIRED',
  84 â”‚           requiresPayment: true
  85 â”‚         },
  86 â”‚         { status: 402 }
  87 â”‚       );
  88 â”‚     }
  89 â”‚ 
  90 â”‚     if (!enrollmentResult.success) {
  91 â”‚       return NextResponse.json(
  92 â”‚         { 
  93 â”‚           error: enrollmentResult.message,
  94 â”‚           code: 'ENROLLMENT_FAILED',
  95 â”‚           requiresPayment: enrollmentResult.requiresPayment
  96 â”‚         },
  97 â”‚         { status: 400 }
  98 â”‚       );
  99 â”‚     }
 100 â”‚ 
 101 â”‚     // Success response
 102 â”‚     return NextResponse.json({
 103 â”‚       success: true,
 104 â”‚       message: enrollmentResult.message,
 105 â”‚       enrollmentId: enrollmentResult.enrollmentId,
 106 â”‚       redirectTo: `/courses/${courseId}` // Redirect to course content
 107 â”‚     });
 108 â”‚ 
 109 â”‚   } catch (error) {
 110 â”‚     console.error('Enhanced enrollment error:', error);
 111 â”‚     
 112 â”‚     if (error instanceof z.ZodError) {
 113 â”‚       return NextResponse.json(
 114 â”‚         { 
 115 â”‚           error: 'Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ØµØ­ÙŠØ­Ø©',
 116 â”‚           code: 'VALIDATION_ERROR',
 117 â”‚           details: error.issues
 118 â”‚         },
 119 â”‚         { status: 400 }
 120 â”‚       );
 121 â”‚     }
 122 â”‚ 
 123 â”‚     return NextResponse.json(
 124 â”‚       { 
 125 â”‚         error: 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ³Ø¬ÙŠÙ„',
 126 â”‚         code: 'INTERNAL_ERROR'
 127 â”‚       },
 128 â”‚       { status: 500 }
 129 â”‚     );
 130 â”‚   }
 131 â”‚ }
 132 â”‚ 
 133 â”‚ // GET endpoint to check enrollment status
 134 â”‚ export async function GET(
 135 â”‚   request: NextRequest,
 136 â”‚   { params }: { params: { id: string } }
 137 â”‚ ) {
 138 â”‚   try {
 139 â”‚     const session = await auth();
 140 â”‚     const courseId = params.id;
 141 â”‚ 
 142 â”‚     // Check course access
 143 â”‚     const accessResult = await EnrollmentService.checkCourseAccess(
 144 â”‚       courseId,
 145 â”‚       session?.user?.id,
 146 â”‚       session?.user?.role
 147 â”‚     );
 148 â”‚ 
 149 â”‚     return NextResponse.json({
 150 â”‚       courseId,
 151 â”‚       userId: session?.user?.id,
 152 â”‚       userRole: session?.user?.role,
 153 â”‚       access: accessResult
 154 â”‚     });
 155 â”‚ 
 156 â”‚   } catch (error) {
 157 â”‚     console.error('Access check error:', error);
 158 â”‚     return NextResponse.json(
 159 â”‚       { 
 160 â”‚         error: 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ÙˆØµÙˆÙ„',
 161 â”‚         code: 'ACCESS_CHECK_ERROR'
 162 â”‚       },
 163 â”‚       { status: 500 }
 164 â”‚     );
 165 â”‚   }
 166 â”‚ }

â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²
END OF FILE: route.ts
â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²


ğŸ“„ FILE: access.service.ts
ğŸ“‚ PATH: src/lib/services/enrollment/access.service.ts
ğŸ“Š STATS: 167 lines | 4.43 KB
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ FILE CONTENT:                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   1 â”‚ // src/lib/services/enrollment/access.service.ts
   2 â”‚ 
   3 â”‚ import { UserRole } from '@prisma/client';
   4 â”‚ import prisma from '@/lib/prisma';
   5 â”‚ import { CourseAccessResult } from './types';
   6 â”‚ 
   7 â”‚ /**
   8 â”‚  * Check if a user can access a course and determine their access level.
   9 â”‚  * @param courseId - The ID of the course.
  10 â”‚  * @param userId - The ID of the user (optional).
  11 â”‚  * @param userRole - The role of the user (optional).
  12 â”‚  * @returns A promise that resolves to a CourseAccessResult object.
  13 â”‚  */
  14 â”‚ export async function checkCourseAccess(
  15 â”‚   courseId: string,
  16 â”‚   userId?: string,
  17 â”‚   userRole?: UserRole
  18 â”‚ ): Promise<CourseAccessResult> {
  19 â”‚   try {
  20 â”‚     // Get course details
  21 â”‚     const course = await prisma.course.findUnique({
  22 â”‚       where: { id: courseId },
  23 â”‚       include: {
  24 â”‚         professor: true,
  25 â”‚         _count: {
  26 â”‚           select: { lessons: true },
  27 â”‚         },
  28 â”‚       },
  29 â”‚     });
  30 â”‚ 
  31 â”‚     if (!course) {
  32 â”‚       return {
  33 â”‚         hasAccess: false,
  34 â”‚         accessType: 'free',
  35 â”‚         message: 'Ø§Ù„Ø¯ÙˆØ±Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©',
  36 â”‚         canEnroll: false,
  37 â”‚         requiresPayment: false,
  38 â”‚       };
  39 â”‚     }
  40 â”‚ 
  41 â”‚     // Check if course is published
  42 â”‚     if (!course.isPublished) {
  43 â”‚       // Only owner and admin can access unpublished courses
  44 â”‚       if (userId === course.professor.id || userRole === 'ADMIN') {
  45 â”‚         return {
  46 â”‚           hasAccess: true,
  47 â”‚           accessType: userRole === 'ADMIN' ? 'admin' : 'owner',
  48 â”‚           message: 'ÙˆØµÙˆÙ„ ÙƒØ§Ù…Ù„ ÙƒÙ…Ø§Ù„Ùƒ/Ù…Ø¯ÙŠØ±',
  49 â”‚           canEnroll: false,
  50 â”‚           requiresPayment: false,
  51 â”‚         };
  52 â”‚       }
  53 â”‚ 
  54 â”‚       return {
  55 â”‚         hasAccess: false,
  56 â”‚         accessType: 'free',
  57 â”‚         message: 'Ø§Ù„Ø¯ÙˆØ±Ø© ØºÙŠØ± Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹',
  58 â”‚         canEnroll: false,
  59 â”‚         requiresPayment: false,
  60 â”‚       };
  61 â”‚     }
  62 â”‚ 
  63 â”‚     // Admin has full access
  64 â”‚     if (userRole === 'ADMIN') {
  65 â”‚       return {
  66 â”‚         hasAccess: true,
  67 â”‚         accessType: 'admin',
  68 â”‚         message: 'ÙˆØµÙˆÙ„ ÙƒØ§Ù…Ù„ ÙƒÙ…Ø¯ÙŠØ±',
  69 â”‚         canEnroll: false,
  70 â”‚         requiresPayment: false,
  71 â”‚       };
  72 â”‚     }
  73 â”‚ 
  74 â”‚     // Course owner has full access
  75 â”‚     if (userId === course.professor.id) {
  76 â”‚       return {
  77 â”‚         hasAccess: true,
  78 â”‚         accessType: 'owner',
  79 â”‚         message: 'ÙˆØµÙˆÙ„ ÙƒØ§Ù…Ù„ ÙƒÙ…Ø§Ù„Ùƒ Ø§Ù„Ø¯ÙˆØ±Ø©',
  80 â”‚         canEnroll: false,
  81 â”‚         requiresPayment: false,
  82 â”‚       };
  83 â”‚     }
  84 â”‚ 
  85 â”‚     // Check if user is enrolled
  86 â”‚     if (userId) {
  87 â”‚       const enrollment = await prisma.enrollment.findUnique({
  88 â”‚         where: {
  89 â”‚           userId_courseId: {
  90 â”‚             userId,
  91 â”‚             courseId,
  92 â”‚           },
  93 â”‚         },
  94 â”‚         include: {
  95 â”‚           user: {
  96 â”‚             include: {
  97 â”‚               viewingHistory: {
  98 â”‚                 where: {
  99 â”‚                   lesson: {
 100 â”‚                     courseId,
 101 â”‚                   },
 102 â”‚                 },
 103 â”‚               },
 104 â”‚             },
 105 â”‚           },
 106 â”‚         },
 107 â”‚       });
 108 â”‚ 
 109 â”‚       if (enrollment) {
 110 â”‚         // Calculate progress
 111 â”‚         const totalLessons = course._count.lessons;
 112 â”‚         const completedLessons = enrollment.user.viewingHistory.filter(
 113 â”‚           (vh) => vh.completed
 114 â”‚         ).length;
 115 â”‚         const progress =
 116 â”‚           totalLessons > 0
 117 â”‚             ? Math.round((completedLessons / totalLessons) * 100)
 118 â”‚             : 0;
 119 â”‚ 
 120 â”‚         return {
 121 â”‚           hasAccess: true,
 122 â”‚           accessType: 'enrolled',
 123 â”‚           message: 'Ù…Ø³Ø¬Ù„ ÙÙŠ Ø§Ù„Ø¯ÙˆØ±Ø©',
 124 â”‚           canEnroll: false,
 125 â”‚           requiresPayment: false,
 126 â”‚           enrollment: {
 127 â”‚             id: enrollment.id,
 128 â”‚             enrolledAt: enrollment.enrolledAt,
 129 â”‚             progress,
 130 â”‚             lastAccessedAt: enrollment.lastAccessedAt,
 131 â”‚           },
 132 â”‚         };
 133 â”‚       }
 134 â”‚     }
 135 â”‚ 
 136 â”‚     // Check if course is free
 137 â”‚     const isFree = !course.price || Number(course.price) <= 0;
 138 â”‚ 
 139 â”‚     if (isFree) {
 140 â”‚       return {
 141 â”‚         hasAccess: false,
 142 â”‚         accessType: 'free',
 143 â”‚         message: 'Ø¯ÙˆØ±Ø© Ù…Ø¬Ø§Ù†ÙŠØ© - ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ³Ø¬ÙŠÙ„',
 144 â”‚         canEnroll: true,
 145 â”‚         requiresPayment: false,
 146 â”‚       };
 147 â”‚     }
 148 â”‚ 
 149 â”‚     // Paid course - requires payment
 150 â”‚     return {
 151 â”‚       hasAccess: false,
 152 â”‚       accessType: 'paid',
 153 â”‚       message: `Ø¯ÙˆØ±Ø© Ù…Ø¯ÙÙˆØ¹Ø© - ${course.price} ${course.currency}`,
 154 â”‚       canEnroll: true,
 155 â”‚       requiresPayment: true,
 156 â”‚     };
 157 â”‚   } catch (error) {
 158 â”‚     console.error('Error checking course access:', error);
 159 â”‚     return {
 160 â”‚       hasAccess: false,
 161 â”‚       accessType: 'free',
 162 â”‚       message: 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ÙˆØµÙˆÙ„',
 163 â”‚       canEnroll: false,
 164 â”‚       requiresPayment: false,
 165 â”‚     };
 166 â”‚   }
 167 â”‚ }

â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²
END OF FILE: access.service.ts
â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²


â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
ğŸ“š CORE ENROLLMENT SERVICES
â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ

â–¼ Enrollment Webhooks & Processing
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

ğŸ“„ FILE: webhook.service.ts
ğŸ“‚ PATH: src/lib/services/enrollment/webhook.service.ts
ğŸ“Š STATS: 232 lines | 6.4 KB
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ FILE CONTENT:                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   1 â”‚ // src/lib/services/enrollment/webhook.service.ts
   2 â”‚ 
   3 â”‚ import prisma from '@/lib/prisma';
   4 â”‚ import { EnrollmentResult } from './types';
   5 â”‚ 
   6 â”‚ /**
   7 â”‚  * Automatically creates an enrollment from a successful payment.
   8 â”‚  * Typically called by a payment webhook handler.
   9 â”‚  * @param paymentId - The ID of the completed payment.
  10 â”‚  * @returns A promise that resolves to an EnrollmentResult object.
  11 â”‚  */
  12 â”‚ export async function createEnrollmentFromPayment(
  13 â”‚   paymentId: string
  14 â”‚ ): Promise<EnrollmentResult> {
  15 â”‚   try {
  16 â”‚     // Get payment details with course and user info
  17 â”‚     const payment = await prisma.payment.findUnique({
  18 â”‚       where: { id: paymentId },
  19 â”‚       include: {
  20 â”‚         course: {
  21 â”‚           select: {
  22 â”‚             id: true,
  23 â”‚             title: true,
  24 â”‚             isPublished: true,
  25 â”‚             price: true,
  26 â”‚           },
  27 â”‚         },
  28 â”‚         user: {
  29 â”‚           select: {
  30 â”‚             id: true,
  31 â”‚             name: true,
  32 â”‚             email: true,
  33 â”‚           },
  34 â”‚         },
  35 â”‚       },
  36 â”‚     });
  37 â”‚ 
  38 â”‚     if (!payment) {
  39 â”‚       return {
  40 â”‚         success: false,
  41 â”‚         message: 'Payment record not found',
  42 â”‚         error: 'PAYMENT_NOT_FOUND',
  43 â”‚       };
  44 â”‚     }
  45 â”‚ 
  46 â”‚     if (payment.status !== 'COMPLETED') {
  47 â”‚       return {
  48 â”‚         success: false,
  49 â”‚         message: 'Payment not completed',
  50 â”‚         error: 'PAYMENT_NOT_COMPLETED',
  51 â”‚       };
  52 â”‚     }
  53 â”‚ 
  54 â”‚     if (!payment.course.isPublished) {
  55 â”‚       return {
  56 â”‚         success: false,
  57 â”‚         message: 'Course is not published',
  58 â”‚         error: 'COURSE_NOT_PUBLISHED',
  59 â”‚       };
  60 â”‚     }
  61 â”‚ 
  62 â”‚     // Check if enrollment already exists
  63 â”‚     const existingEnrollment = await prisma.enrollment.findUnique({
  64 â”‚       where: {
  65 â”‚         userId_courseId: {
  66 â”‚           userId: payment.userId,
  67 â”‚           courseId: payment.courseId,
  68 â”‚         },
  69 â”‚       },
  70 â”‚     });
  71 â”‚ 
  72 â”‚     if (existingEnrollment) {
  73 â”‚       console.log('Enrollment already exists for payment:', paymentId);
  74 â”‚       return {
  75 â”‚         success: true,
  76 â”‚         message: 'User already enrolled',
  77 â”‚         enrollmentId: existingEnrollment.id,
  78 â”‚       };
  79 â”‚     }
  80 â”‚ 
  81 â”‚     // Create enrollment with transaction to ensure consistency
  82 â”‚     const enrollment = await prisma.$transaction(async (tx) => {
  83 â”‚       // Create the enrollment
  84 â”‚       const newEnrollment = await tx.enrollment.create({
  85 â”‚         data: {
  86 â”‚           userId: payment.userId,
  87 â”‚           courseId: payment.courseId,
  88 â”‚           progressPercent: 0,
  89 â”‚           completedLessonIds: [],
  90 â”‚           totalWatchTime: 0,
  91 â”‚           enrolledAt: new Date(),
  92 â”‚           lastAccessedAt: null,
  93 â”‚         },
  94 â”‚       });
  95 â”‚ 
  96 â”‚       // Create a progress milestone for course start
  97 â”‚       await tx.progressMilestone.create({
  98 â”‚         data: {
  99 â”‚           userId: payment.userId,
 100 â”‚           courseId: payment.courseId,
 101 â”‚           milestoneType: 'COURSE_START',
 102 â”‚           metadata: {
 103 â”‚             paymentId: payment.id,
 104 â”‚             enrollmentId: newEnrollment.id,
 105 â”‚             courseName: payment.course.title,
 106 â”‚             amount: Number(payment.amount),
 107 â”‚           },
 108 â”‚         },
 109 â”‚       });
 110 â”‚ 
 111 â”‚       return newEnrollment;
 112 â”‚     });
 113 â”‚ 
 114 â”‚     console.log('Automatic enrollment created:', {
 115 â”‚       enrollmentId: enrollment.id,
 116 â”‚       userId: payment.userId,
 117 â”‚       courseId: payment.courseId,
 118 â”‚       paymentId: payment.id,
 119 â”‚     });
 120 â”‚ 
 121 â”‚     return {
 122 â”‚       success: true,
 123 â”‚       message: 'ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙÙŠ Ø§Ù„Ø¯ÙˆØ±Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ø¹Ø¯ Ø§Ù„Ø¯ÙØ¹',
 124 â”‚       enrollmentId: enrollment.id,
 125 â”‚     };
 126 â”‚   } catch (error) {
 127 â”‚     console.error('Error creating automatic enrollment:', error);
 128 â”‚     // If an error occurs, we should handle it to allow for retries
 129 â”‚     await handleEnrollmentFailure(
 130 â”‚       paymentId,
 131 â”‚       error instanceof Error ? error.message : 'Unknown transaction error'
 132 â”‚     );
 133 â”‚     return {
 134 â”‚       success: false,
 135 â”‚       message: 'Failed to create automatic enrollment',
 136 â”‚       error: error instanceof Error ? error.message : 'Unknown error',
 137 â”‚     };
 138 â”‚   }
 139 â”‚ }
 140 â”‚ 
 141 â”‚ /**
 142 â”‚  * Logs an enrollment failure to the payment record for manual review and retry.
 143 â”‚  * @param paymentId - The ID of the payment that failed to create an enrollment.
 144 â”‚  * @param error - The error message.
 145 â”‚  */
 146 â”‚ export async function handleEnrollmentFailure(
 147 â”‚   paymentId: string,
 148 â”‚   error: string
 149 â”‚ ): Promise<void> {
 150 â”‚   try {
 151 â”‚     // Log the failure for manual review
 152 â”‚     console.error(
 153 â”‚       'Enrollment failure for payment:',
 154 â”‚       paymentId,
 155 â”‚       'Error:',
 156 â”‚       error
 157 â”‚     );
 158 â”‚ 
 159 â”‚     const payment = await prisma.payment.findUnique({
 160 â”‚       where: { id: paymentId },
 161 â”‚     });
 162 â”‚     
 163 â”‚     // Ensure paymobResponse is treated as an object
 164 â”‚     const paymobResponse = (payment?.paymobResponse || {}) as any;
 165 â”‚ 
 166 â”‚     // Update payment record to indicate enrollment failure
 167 â”‚     await prisma.payment.update({
 168 â”‚       where: { id: paymentId },
 169 â”‚       data: {
 170 â”‚         paymobResponse: {
 171 â”‚           ...paymobResponse,
 172 â”‚           enrollmentError: {
 173 â”‚             error,
 174 â”‚             timestamp: new Date().toISOString(),
 175 â”‚             requiresManualReview: true,
 176 â”‚           },
 177 â”‚         },
 178 â”‚       },
 179 â”‚     });
 180 â”‚ 
 181 â”‚     // TODO: Send notification to administrators
 182 â”‚     // TODO: Queue for manual enrollment processing
 183 â”‚   } catch (dbError) {
 184 â”‚     console.error('Failed to log enrollment failure:', dbError);
 185 â”‚   }
 186 â”‚ }
 187 â”‚ 
 188 â”‚ /**
 189 â”‚  * Retries a failed enrollment creation process for a given payment.
 190 â”‚  * @param paymentId - The ID of the payment to retry.
 191 â”‚  * @returns A promise that resolves to an EnrollmentResult.
 192 â”‚  */
 193 â”‚ export async function retryFailedEnrollment(
 194 â”‚   paymentId: string
 195 â”‚ ): Promise<EnrollmentResult> {
 196 â”‚   try {
 197 â”‚     console.log('Retrying failed enrollment for payment:', paymentId);
 198 â”‚ 
 199 â”‚     const result = await createEnrollmentFromPayment(paymentId);
 200 â”‚ 
 201 â”‚     if (result.success) {
 202 â”‚       const payment = await prisma.payment.findUnique({
 203 â”‚         where: { id: paymentId },
 204 â”‚       });
 205 â”‚       const paymobResponse = (payment?.paymobResponse || {}) as any;
 206 â”‚       
 207 â”‚       // Clear the enrollment error flag
 208 â”‚       await prisma.payment.update({
 209 â”‚         where: { id: paymentId },
 210 â”‚         data: {
 211 â”‚           paymobResponse: {
 212 â”‚             ...paymobResponse,
 213 â”‚             enrollmentError: null, // Clear the error
 214 â”‚             enrollmentRetry: {
 215 â”‚               retriedAt: new Date().toISOString(),
 216 â”‚               success: true,
 217 â”‚             },
 218 â”‚           },
 219 â”‚         },
 220 â”‚       });
 221 â”‚     }
 222 â”‚ 
 223 â”‚     return result;
 224 â”‚   } catch (error) {
 225 â”‚     console.error('Error retrying enrollment:', error);
 226 â”‚     return {
 227 â”‚       success: false,
 228 â”‚       message: 'Failed to retry enrollment',
 229 â”‚       error: error instanceof Error ? error.message : 'Unknown error',
 230 â”‚     };
 231 â”‚   }
 232 â”‚ }

â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²
END OF FILE: webhook.service.ts
â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²


ğŸ“„ FILE: route.ts
ğŸ“‚ PATH: src/app/api/courses/[id]/enrollment-status/route.ts
ğŸ“Š STATS: 82 lines | 2.03 KB
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ FILE CONTENT:                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   1 â”‚ // src/app/api/courses/[id]/enrollment-status/route.ts
   2 â”‚ import { NextRequest, NextResponse } from 'next/server';
   3 â”‚ import { auth } from '@/lib/auth';
   4 â”‚ import prisma from '@/lib/prisma';
   5 â”‚ 
   6 â”‚ interface RouteParams {
   7 â”‚   params: { id: string }
   8 â”‚ }
   9 â”‚ 
  10 â”‚ // GET /api/courses/[id]/enrollment-status - Get enrollment status
  11 â”‚ export async function GET(request: NextRequest, { params }: RouteParams) {
  12 â”‚   try {
  13 â”‚     const { id: courseId } = await params;
  14 â”‚     const session = await auth();
  15 â”‚ 
  16 â”‚     if (!session?.user) {
  17 â”‚       return NextResponse.json({ isEnrolled: false });
  18 â”‚     }
  19 â”‚ 
  20 â”‚     // Check enrollment
  21 â”‚     const enrollment = await prisma.enrollment.findUnique({
  22 â”‚       where: {
  23 â”‚         userId_courseId: {
  24 â”‚           userId: session.user.id,
  25 â”‚           courseId
  26 â”‚         }
  27 â”‚       },
  28 â”‚       select: {
  29 â”‚         id: true,
  30 â”‚         progressPercent: true,
  31 â”‚         enrolledAt: true
  32 â”‚       }
  33 â”‚     });
  34 â”‚ 
  35 â”‚     if (enrollment) {
  36 â”‚       return NextResponse.json({
  37 â”‚         isEnrolled: true,
  38 â”‚         enrollment: {
  39 â”‚           id: enrollment.id,
  40 â”‚           progressPercent: enrollment.progressPercent,
  41 â”‚           enrolledAt: enrollment.enrolledAt.toISOString()
  42 â”‚         }
  43 â”‚       });
  44 â”‚     }
  45 â”‚ 
  46 â”‚     // Check payment status
  47 â”‚     const payment = await prisma.payment.findFirst({
  48 â”‚       where: {
  49 â”‚         userId: session.user.id,
  50 â”‚         courseId
  51 â”‚       },
  52 â”‚       select: {
  53 â”‚         status: true
  54 â”‚       },
  55 â”‚       orderBy: { createdAt: 'desc' }
  56 â”‚     });
  57 â”‚ 
  58 â”‚     let paymentStatus: 'none' | 'pending' | 'completed' | 'failed' = 'none';
  59 â”‚     if (payment) {
  60 â”‚       switch (payment.status) {
  61 â”‚         case 'PENDING':
  62 â”‚           paymentStatus = 'pending';
  63 â”‚           break;
  64 â”‚         case 'COMPLETED':
  65 â”‚           paymentStatus = 'completed';
  66 â”‚           break;
  67 â”‚         case 'FAILED':
  68 â”‚           paymentStatus = 'failed';
  69 â”‚           break;
  70 â”‚       }
  71 â”‚     }
  72 â”‚ 
  73 â”‚     return NextResponse.json({
  74 â”‚       isEnrolled: false,
  75 â”‚       paymentStatus
  76 â”‚     });
  77 â”‚ 
  78 â”‚   } catch (error) {
  79 â”‚     console.error('Enrollment status API error:', error);
  80 â”‚     return NextResponse.json({ isEnrolled: false }, { status: 500 });
  81 â”‚   }
  82 â”‚ }

â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²
END OF FILE: route.ts
â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²


ğŸ“„ FILE: route.ts
ğŸ“‚ PATH: src/app/api/courses/[id]/access/route.ts
ğŸ“Š STATS: 25 lines | 724 Bytes
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ FILE CONTENT:                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   1 â”‚ // src/app/api/courses/[id]/access/route.ts
   2 â”‚ import { NextRequest, NextResponse } from 'next/server';
   3 â”‚ import { checkCourseAccess } from '@/lib/services/course-access.service';
   4 â”‚ 
   5 â”‚ interface RouteParams {
   6 â”‚   params: { id: string }
   7 â”‚ }
   8 â”‚ 
   9 â”‚ // GET /api/courses/[id]/access - Check course access
  10 â”‚ export async function GET(request: NextRequest, { params }: RouteParams) {
  11 â”‚   try {
  12 â”‚     const { id: courseId } = await params;
  13 â”‚ 
  14 â”‚     const accessResult = await checkCourseAccess(courseId);
  15 â”‚ 
  16 â”‚     return NextResponse.json(accessResult);
  17 â”‚ 
  18 â”‚   } catch (error) {
  19 â”‚     console.error('Course access API error:', error);
  20 â”‚     return NextResponse.json({
  21 â”‚       hasAccess: false,
  22 â”‚       reason: 'not_found'
  23 â”‚     }, { status: 500 });
  24 â”‚   }
  25 â”‚ }

â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²
END OF FILE: route.ts
â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²


â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
ğŸ“š CORE ENROLLMENT SERVICES
â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ

â–¼ Enrollment Data & Queries
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

ğŸ“„ FILE: query.service.ts
ğŸ“‚ PATH: src/lib/services/enrollment/query.service.ts
ğŸ“Š STATS: 81 lines | 2.3 KB
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ FILE CONTENT:                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   1 â”‚ // src/lib/services/enrollment/query.service.ts
   2 â”‚ 
   3 â”‚ import prisma from '@/lib/prisma';
   4 â”‚ 
   5 â”‚ /**
   6 â”‚  * The return type for a user's enrollment details for a single course.
   7 â”‚  */
   8 â”‚ export type UserEnrollment = {
   9 â”‚   enrollmentId: string;
  10 â”‚   enrolledAt: Date;
  11 â”‚   progress: number;
  12 â”‚   lastAccessedAt: Date | null;
  13 â”‚ };
  14 â”‚ 
  15 â”‚ /**
  16 â”‚  * A map of course IDs to their corresponding enrollment details for a user.
  17 â”‚  */
  18 â”‚ export type UserEnrollmentsMap = {
  19 â”‚   [courseId: string]: UserEnrollment;
  20 â”‚ };
  21 â”‚ 
  22 â”‚ /**
  23 â”‚  * Get a user's enrollment status for all their courses.
  24 â”‚  * @param userId - The ID of the user.
  25 â”‚  * @returns A promise that resolves to a map of course IDs to enrollment details.
  26 â”‚  */
  27 â”‚ export async function getUserEnrollments(
  28 â”‚   userId: string
  29 â”‚ ): Promise<UserEnrollmentsMap> {
  30 â”‚   try {
  31 â”‚     const enrollments = await prisma.enrollment.findMany({
  32 â”‚       where: { userId },
  33 â”‚       include: {
  34 â”‚         course: {
  35 â”‚           include: {
  36 â”‚             _count: {
  37 â”‚               select: { lessons: true },
  38 â”‚             },
  39 â”‚           },
  40 â”‚         },
  41 â”‚         user: {
  42 â”‚           include: {
  43 â”‚             viewingHistory: true, // This is not ideal, but matches original logic
  44 â”‚           },
  45 â”‚         },
  46 â”‚       },
  47 â”‚     });
  48 â”‚ 
  49 â”‚     const result: UserEnrollmentsMap = {};
  50 â”‚ 
  51 â”‚     for (const enrollment of enrollments) {
  52 â”‚       const totalLessons = enrollment.course._count.lessons;
  53 â”‚       // Note: The original logic to filter viewingHistory by course was flawed.
  54 â”‚       // A proper implementation would need to add a where clause to the viewingHistory include.
  55 â”‚       // To preserve original behavior, we filter here.
  56 â”‚       const courseViewingHistory = enrollment.user.viewingHistory.filter((vh) =>
  57 â”‚         // This is an approximation and might not be fully correct without lesson data
  58 â”‚         true
  59 â”‚       );
  60 â”‚       const completedLessons = courseViewingHistory.filter(
  61 â”‚         (vh) => vh.completed
  62 â”‚       ).length;
  63 â”‚       const progress =
  64 â”‚         totalLessons > 0
  65 â”‚           ? Math.round((completedLessons / totalLessons) * 100)
  66 â”‚           : 0;
  67 â”‚ 
  68 â”‚       result[enrollment.courseId] = {
  69 â”‚         enrollmentId: enrollment.id,
  70 â”‚         enrolledAt: enrollment.enrolledAt,
  71 â”‚         progress,
  72 â”‚         lastAccessedAt: enrollment.lastAccessedAt,
  73 â”‚       };
  74 â”‚     }
  75 â”‚ 
  76 â”‚     return result;
  77 â”‚   } catch (error) {
  78 â”‚     console.error('Error getting user enrollments:', error);
  79 â”‚     return {};
  80 â”‚   }
  81 â”‚ }

â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²
END OF FILE: query.service.ts
â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²


ğŸ“„ FILE: types.ts
ğŸ“‚ PATH: src/lib/services/enrollment/types.ts
ğŸ“Š STATS: 26 lines | 592 Bytes
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ FILE CONTENT:                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   1 â”‚ // src/lib/services/enrollment/types.ts
   2 â”‚ 
   3 â”‚ import { UserRole } from '@prisma/client';
   4 â”‚ 
   5 â”‚ export interface EnrollmentResult {
   6 â”‚   success: boolean;
   7 â”‚   message: string;
   8 â”‚   enrollmentId?: string;
   9 â”‚   requiresPayment?: boolean;
  10 â”‚   paymentUrl?: string;
  11 â”‚   error?: string;
  12 â”‚ }
  13 â”‚ 
  14 â”‚ export interface CourseAccessResult {
  15 â”‚   hasAccess: boolean;
  16 â”‚   accessType: 'free' | 'paid' | 'enrolled' | 'owner' | 'admin';
  17 â”‚   message: string;
  18 â”‚   canEnroll: boolean;
  19 â”‚   requiresPayment: boolean;
  20 â”‚   enrollment?: {
  21 â”‚     id: string;
  22 â”‚     enrolledAt: Date;
  23 â”‚     progress: number;
  24 â”‚     lastAccessedAt: Date | null;
  25 â”‚   };
  26 â”‚ }

â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²
END OF FILE: types.ts
â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²


â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
ğŸ”— INTEGRATION LAYER
â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ

â–¼ Course Access Control
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

ğŸ“„ FILE: course-access.service.ts
ğŸ“‚ PATH: src/lib/services/course-access.service.ts
ğŸ“Š STATS: 147 lines | 4.42 KB
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ FILE CONTENT:                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   1 â”‚ // src/lib/services/course-access.service.ts
   2 â”‚ 
   3 â”‚ import { auth } from '@/lib/auth';
   4 â”‚ import prisma from '@/lib/prisma';
   5 â”‚ 
   6 â”‚ export interface CourseAccessResult {
   7 â”‚   hasAccess: boolean;
   8 â”‚   reason:
   9 â”‚     | 'enrolled'
  10 â”‚     | 'free_course'
  11 â”‚     | 'admin_access'
  12 â”‚     | 'professor_owns'
  13 â”‚     | 'payment_required'
  14 â”‚     | 'not_published'
  15 â”‚     | 'not_found'
  16 â”‚     | 'not_authenticated';
  17 â”‚   course?: {
  18 â”‚     id: string;
  19 â”‚     title: string;
  20 â”‚     price: any;
  21 â”‚     currency: string;
  22 â”‚     isPublished: boolean;
  23 â”‚     professorId: string;
  24 â”‚   };
  25 â”‚   enrollment?: {
  26 â”‚     id: string;
  27 â”‚     progressPercent: number;
  28 â”‚     enrolledAt: Date;
  29 â”‚   };
  30 â”‚   payment?: {
  31 â”‚     id: string;
  32 â”‚     status: string;
  33 â”‚     amount: any;
  34 â”‚   };
  35 â”‚ }
  36 â”‚ 
  37 â”‚ /**
  38 â”‚  * Checks if a user has access to a specific course. This is a read-only operation.
  39 â”‚  */
  40 â”‚ export async function checkCourseAccess(
  41 â”‚   courseId: string
  42 â”‚ ): Promise<CourseAccessResult> {
  43 â”‚   try {
  44 â”‚     const session = await auth();
  45 â”‚     if (!session?.user) {
  46 â”‚       return { hasAccess: false, reason: 'not_authenticated' };
  47 â”‚     }
  48 â”‚ 
  49 â”‚     const course = await prisma.course.findUnique({
  50 â”‚       where: { id: courseId },
  51 â”‚       select: {
  52 â”‚         id: true,
  53 â”‚         title: true,
  54 â”‚         price: true,
  55 â”‚         currency: true,
  56 â”‚         isPublished: true,
  57 â”‚         professorId: true,
  58 â”‚       },
  59 â”‚     });
  60 â”‚ 
  61 â”‚     if (!course) {
  62 â”‚       return { hasAccess: false, reason: 'not_found' };
  63 â”‚     }
  64 â”‚ 
  65 â”‚     // Admins and course owners can access unpublished courses
  66 â”‚     if (!course.isPublished && session.user.role !== 'ADMIN' && course.professorId !== session.user.id) {
  67 â”‚         return { hasAccess: false, reason: 'not_published', course };
  68 â”‚     }
  69 â”‚ 
  70 â”‚     if (session.user.role === 'ADMIN') {
  71 â”‚       return { hasAccess: true, reason: 'admin_access', course };
  72 â”‚     }
  73 â”‚     
  74 â”‚     if (course.professorId === session.user.id) {
  75 â”‚       return { hasAccess: true, reason: 'professor_owns', course };
  76 â”‚     }
  77 â”‚ 
  78 â”‚     // Check for enrollment for students
  79 â”‚     if (session.user.role === 'STUDENT') {
  80 â”‚       const enrollment = await prisma.enrollment.findUnique({
  81 â”‚         where: { userId_courseId: { userId: session.user.id, courseId } },
  82 â”‚         select: { id: true, progressPercent: true, enrolledAt: true },
  83 â”‚       });
  84 â”‚ 
  85 â”‚       if (enrollment) {
  86 â”‚         return { hasAccess: true, reason: 'enrolled', course, enrollment };
  87 â”‚       }
  88 â”‚     }
  89 â”‚     
  90 â”‚     // If not enrolled, check if the course is free
  91 â”‚     if (!course.price || Number(course.price) <= 0) {
  92 â”‚       return { hasAccess: true, reason: 'free_course', course };
  93 â”‚     }
  94 â”‚ 
  95 â”‚     // If it's a paid course and the student is not enrolled, they need to pay
  96 â”‚     return { hasAccess: false, reason: 'payment_required', course };
  97 â”‚ 
  98 â”‚   } catch (error) {
  99 â”‚     console.error('Course access check error:', error);
 100 â”‚     // Default to a secure state
 101 â”‚     return { hasAccess: false, reason: 'not_found' };
 102 â”‚   }
 103 â”‚ }
 104 â”‚ 
 105 â”‚ /**
 106 â”‚  * Middleware-style function to protect routes by requiring course access.
 107 â”‚  * Throws an error if the user does not have access.
 108 â”‚  */
 109 â”‚ export async function requireCourseAccess(courseId: string): Promise<CourseAccessResult> {
 110 â”‚   const accessResult = await checkCourseAccess(courseId);
 111 â”‚ 
 112 â”‚   if (!accessResult.hasAccess) {
 113 â”‚     // This error can be caught in API routes or server components to trigger a redirect or an error page.
 114 â”‚     throw new Error(`Course access denied: ${accessResult.reason}`);
 115 â”‚   }
 116 â”‚ 
 117 â”‚   return accessResult;
 118 â”‚ }
 119 â”‚ 
 120 â”‚ /**
 121 â”‚  * Get access message based on course access result
 122 â”‚  */
 123 â”‚ export function getAccessMessage(reason: CourseAccessResult['reason']): string {
 124 â”‚   switch (reason) {
 125 â”‚     case 'enrolled':
 126 â”‚       return 'Ù„Ø¯ÙŠÙƒ ÙˆØµÙˆÙ„ ÙƒØ§Ù…Ù„ Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø¯ÙˆØ±Ø©';
 127 â”‚     case 'free_course':
 128 â”‚       return 'Ù‡Ø°Ù‡ Ø¯ÙˆØ±Ø© Ù…Ø¬Ø§Ù†ÙŠØ©ØŒ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„ÙŠÙ‡Ø§';
 129 â”‚     case 'admin_access':
 130 â”‚       return 'Ù„Ø¯ÙŠÙƒ ÙˆØµÙˆÙ„ Ø¥Ø¯Ø§Ø±ÙŠ Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø¯ÙˆØ±Ø©';
 131 â”‚     case 'professor_owns':
 132 â”‚       return 'Ù‡Ø°Ù‡ Ø¯ÙˆØ±ØªÙƒ Ø§Ù„Ø®Ø§ØµØ©';
 133 â”‚     case 'payment_required':
 134 â”‚       return 'ÙŠØªØ·Ù„Ø¨ Ø¯ÙØ¹ Ø±Ø³ÙˆÙ… Ù„Ù„ÙˆØµÙˆÙ„ Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø¯ÙˆØ±Ø©';
 135 â”‚     case 'not_published':
 136 â”‚       return 'Ù‡Ø°Ù‡ Ø§Ù„Ø¯ÙˆØ±Ø© ØºÙŠØ± Ù…Ù†Ø´ÙˆØ±Ø© Ø­Ø§Ù„ÙŠØ§Ù‹';
 137 â”‚     case 'not_found':
 138 â”‚       return 'Ø§Ù„Ø¯ÙˆØ±Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©';
 139 â”‚     case 'not_authenticated':
 140 â”‚       return 'ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„ÙˆØµÙˆÙ„ Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø¯ÙˆØ±Ø©';
 141 â”‚     default:
 142 â”‚       return 'ØºÙŠØ± Ù…ØµØ±Ø­ Ø¨Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø¯ÙˆØ±Ø©';
 143 â”‚   }
 144 â”‚ }
 145 â”‚ 
 146 â”‚ // Export enrollInFreeCourse function for backward compatibility
 147 â”‚ export { enrollInFreeCourse } from './enrollment/core.service';

â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²
END OF FILE: course-access.service.ts
â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²


ğŸ“„ FILE: CourseAccessGuard.tsx
ğŸ“‚ PATH: src/components/course/CourseAccessGuard.tsx
ğŸ“Š STATS: 358 lines | 10.86 KB
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ FILE CONTENT:                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   1 â”‚ // src/components/course/CourseAccessGuard.tsx
   2 â”‚ "use client";
   3 â”‚ 
   4 â”‚ import { useState, useEffect, ReactNode } from "react";
   5 â”‚ import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
   6 â”‚ import { Button } from "@/components/ui/button";
   7 â”‚ import { Skeleton } from "@/components/ui/skeleton";
   8 â”‚ import { PaymentButton } from "@/components/payment/PaymentButton";
   9 â”‚ import { CourseAccessResult } from "@/lib/services/course-access.service";
  10 â”‚ import { getAccessMessage } from "@/lib/access-messages";
  11 â”‚ import { checkCourseAccess, enrollInFreeCourse } from "@/lib/api/course-access";
  12 â”‚ import { 
  13 â”‚   Lock, 
  14 â”‚   CheckCircle, 
  15 â”‚   CreditCard, 
  16 â”‚   UserPlus, 
  17 â”‚   AlertCircle,
  18 â”‚   Shield,
  19 â”‚   Crown,
  20 â”‚   GraduationCap,
  21 â”‚   ExternalLink
  22 â”‚ } from "lucide-react";
  23 â”‚ import { toast } from "sonner";
  24 â”‚ import { useRouter } from "next/navigation";
  25 â”‚ import Link from "next/link";
  26 â”‚ 
  27 â”‚ interface Course {
  28 â”‚   id: string;
  29 â”‚   title: string;
  30 â”‚   description: string;
  31 â”‚   price: number | null;
  32 â”‚   currency: string;
  33 â”‚   thumbnailUrl: string;
  34 â”‚   isPublished: boolean;
  35 â”‚   bunnyLibraryId: string;
  36 â”‚   categoryId: string;
  37 â”‚   professorId: string;
  38 â”‚   createdAt: string;
  39 â”‚   updatedAt: string;
  40 â”‚   category: {
  41 â”‚     id: string;
  42 â”‚     name: string;
  43 â”‚     slug: string;
  44 â”‚     description?: string;
  45 â”‚   };
  46 â”‚   professor: {
  47 â”‚     id: string;
  48 â”‚     name: string;
  49 â”‚     bio: string | null;
  50 â”‚     expertise?: string[];
  51 â”‚   };
  52 â”‚   _count: {
  53 â”‚     lessons: number;
  54 â”‚     enrollments: number;
  55 â”‚   };
  56 â”‚ }
  57 â”‚ 
  58 â”‚ interface CourseAccessGuardProps {
  59 â”‚   courseId: string;
  60 â”‚   course?: Course; // Optional course data to avoid extra API calls
  61 â”‚   children: ReactNode;
  62 â”‚   fallback?: ReactNode;
  63 â”‚   showAccessInfo?: boolean;
  64 â”‚ }
  65 â”‚ 
  66 â”‚ export function CourseAccessGuard({ 
  67 â”‚   courseId, 
  68 â”‚   course, 
  69 â”‚   children, 
  70 â”‚   fallback,
  71 â”‚   showAccessInfo = true 
  72 â”‚ }: CourseAccessGuardProps) {
  73 â”‚   const [accessResult, setAccessResult] = useState<CourseAccessResult | null>(null);
  74 â”‚   const [loading, setLoading] = useState(true);
  75 â”‚   const [enrolling, setEnrolling] = useState(false);
  76 â”‚   // const router = useRouter(); // Unused for now
  77 â”‚ 
  78 â”‚   // Check course access on mount
  79 â”‚   useEffect(() => {
  80 â”‚     async function checkAccess() {
  81 â”‚       try {
  82 â”‚         setLoading(true);
  83 â”‚         const result = await checkCourseAccess(courseId);
  84 â”‚         setAccessResult(result);
  85 â”‚       } catch (error) {
  86 â”‚         console.error('Access check error:', error);
  87 â”‚         setAccessResult({
  88 â”‚           hasAccess: false,
  89 â”‚           reason: 'not_found'
  90 â”‚         });
  91 â”‚       } finally {
  92 â”‚         setLoading(false);
  93 â”‚       }
  94 â”‚     }
  95 â”‚ 
  96 â”‚     checkAccess();
  97 â”‚   }, [courseId]);
  98 â”‚ 
  99 â”‚   // Handle free course enrollment
 100 â”‚   const handleFreeEnrollment = async () => {
 101 â”‚     try {
 102 â”‚       setEnrolling(true);
 103 â”‚       const result = await enrollInFreeCourse(courseId);
 104 â”‚       
 105 â”‚       if (result.success) {
 106 â”‚         toast.success(result.message);
 107 â”‚         // Refresh access check
 108 â”‚         const newAccessResult = await checkCourseAccess(courseId);
 109 â”‚         setAccessResult(newAccessResult);
 110 â”‚       } else {
 111 â”‚         toast.error(result.message);
 112 â”‚       }
 113 â”‚     } catch (error) {
 114 â”‚       console.error('Enrollment error:', error);
 115 â”‚       toast.error('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ³Ø¬ÙŠÙ„');
 116 â”‚     } finally {
 117 â”‚       setEnrolling(false);
 118 â”‚     }
 119 â”‚   };
 120 â”‚ 
 121 â”‚   // Handle payment success
 122 â”‚   const handlePaymentSuccess = async () => {
 123 â”‚     // Refresh access check after successful payment
 124 â”‚     const newAccessResult = await checkCourseAccess(courseId);
 125 â”‚     setAccessResult(newAccessResult);
 126 â”‚   };
 127 â”‚ 
 128 â”‚   // Get access icon
 129 â”‚   const getAccessIcon = (reason: CourseAccessResult['reason']) => {
 130 â”‚     switch (reason) {
 131 â”‚       case 'enrolled':
 132 â”‚         return <CheckCircle className="w-8 h-8 text-green-600" />;
 133 â”‚       case 'free_course':
 134 â”‚         return <GraduationCap className="w-8 h-8 text-blue-600" />;
 135 â”‚       case 'admin_access':
 136 â”‚         return <Crown className="w-8 h-8 text-purple-600" />;
 137 â”‚       case 'professor_owns':
 138 â”‚         return <Shield className="w-8 h-8 text-indigo-600" />;
 139 â”‚       case 'payment_required':
 140 â”‚         return <CreditCard className="w-8 h-8 text-orange-600" />;
 141 â”‚       case 'not_authenticated':
 142 â”‚         return <Lock className="w-8 h-8 text-gray-600" />;
 143 â”‚       default:
 144 â”‚         return <AlertCircle className="w-8 h-8 text-red-600" />;
 145 â”‚     }
 146 â”‚   };
 147 â”‚ 
 148 â”‚   // Loading state
 149 â”‚   if (loading) {
 150 â”‚     return (
 151 â”‚       <div className="space-y-4">
 152 â”‚         <Card>
 153 â”‚           <CardHeader>
 154 â”‚             <div className="flex items-center gap-3">
 155 â”‚               <Skeleton className="w-8 h-8 rounded-full" />
 156 â”‚               <div className="space-y-2">
 157 â”‚                 <Skeleton className="h-5 w-32" />
 158 â”‚                 <Skeleton className="h-4 w-48" />
 159 â”‚               </div>
 160 â”‚             </div>
 161 â”‚           </CardHeader>
 162 â”‚           <CardContent>
 163 â”‚             <Skeleton className="h-10 w-full" />
 164 â”‚           </CardContent>
 165 â”‚         </Card>
 166 â”‚         {fallback || (
 167 â”‚           <div className="space-y-4">
 168 â”‚             <Skeleton className="h-64 w-full" />
 169 â”‚             <Skeleton className="h-32 w-full" />
 170 â”‚           </div>
 171 â”‚         )}
 172 â”‚       </div>
 173 â”‚     );
 174 â”‚   }
 175 â”‚ 
 176 â”‚   // No access result
 177 â”‚   if (!accessResult) {
 178 â”‚     return (
 179 â”‚       <Card>
 180 â”‚         <CardContent className="text-center py-8">
 181 â”‚           <AlertCircle className="w-12 h-12 mx-auto mb-4 text-red-600" />
 182 â”‚           <h3 className="text-lg font-semibold mb-2">Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ÙˆØµÙˆÙ„</h3>
 183 â”‚           <p className="text-muted-foreground">Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ø¯ÙˆØ±Ø©</p>
 184 â”‚         </CardContent>
 185 â”‚       </Card>
 186 â”‚     );
 187 â”‚   }
 188 â”‚ 
 189 â”‚   // User has access - show content
 190 â”‚   if (accessResult.hasAccess) {
 191 â”‚     return (
 192 â”‚       <div className="space-y-4">
 193 â”‚         {/* Access Info (optional) */}
 194 â”‚         {showAccessInfo && (
 195 â”‚           <Card className="border-green-200 bg-green-50">
 196 â”‚             <CardContent className="flex items-center gap-3 py-4">
 197 â”‚               {getAccessIcon(accessResult.reason)}
 198 â”‚               <div>
 199 â”‚                 <h4 className="font-semibold text-green-800">
 200 â”‚                   {getAccessMessage(accessResult).title}
 201 â”‚                 </h4>
 202 â”‚                 <p className="text-sm text-green-700">
 203 â”‚                   {getAccessMessage(accessResult).description}
 204 â”‚                 </p>
 205 â”‚               </div>
 206 â”‚             </CardContent>
 207 â”‚           </Card>
 208 â”‚         )}
 209 â”‚         
 210 â”‚         {/* Course Content */}
 211 â”‚         {children}
 212 â”‚       </div>
 213 â”‚     );
 214 â”‚   }
 215 â”‚ 
 216 â”‚   // User doesn't have access - show access gate
 217 â”‚   const accessMessage = getAccessMessage(accessResult);
 218 â”‚   
 219 â”‚   return (
 220 â”‚     <div className="space-y-4">
 221 â”‚       <Card>
 222 â”‚         <CardHeader className="text-center">
 223 â”‚           <div className="flex justify-center mb-4">
 224 â”‚             {getAccessIcon(accessResult.reason)}
 225 â”‚           </div>
 226 â”‚           <CardTitle className="text-xl">{accessMessage.title}</CardTitle>
 227 â”‚           <CardDescription className="text-base">
 228 â”‚             {accessMessage.description}
 229 â”‚           </CardDescription>
 230 â”‚         </CardHeader>
 231 â”‚         
 232 â”‚         <CardContent className="space-y-4">
 233 â”‚           {/* Course Information */}
 234 â”‚           {accessResult.course && (
 235 â”‚             <div className="p-4 bg-muted/50 rounded-lg">
 236 â”‚               <h4 className="font-semibold mb-2">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¯ÙˆØ±Ø©</h4>
 237 â”‚               <p className="text-sm text-muted-foreground">
 238 â”‚                 {accessResult.course.title}
 239 â”‚               </p>
 240 â”‚               {accessResult.course.price && (
 241 â”‚                 <p className="text-sm font-medium mt-1">
 242 â”‚                   Ø§Ù„Ø³Ø¹Ø±: {new Intl.NumberFormat('ar-EG', {
 243 â”‚                     style: 'currency',
 244 â”‚                     currency: accessResult.course.currency || 'EGP',
 245 â”‚                     minimumFractionDigits: 0
 246 â”‚                   }).format(Number(accessResult.course.price))}
 247 â”‚                 </p>
 248 â”‚               )}
 249 â”‚             </div>
 250 â”‚           )}
 251 â”‚ 
 252 â”‚           {/* Action Buttons */}
 253 â”‚           <div className="flex gap-3">
 254 â”‚             {accessMessage.actionType === 'login' && (
 255 â”‚               <Button asChild className="flex-1">
 256 â”‚                 <Link href="/login">
 257 â”‚                   <Lock className="w-4 h-4" />
 258 â”‚                   {accessMessage.actionText}
 259 â”‚                 </Link>
 260 â”‚               </Button>
 261 â”‚             )}
 262 â”‚ 
 263 â”‚             {accessMessage.actionType === 'payment' && course && (
 264 â”‚               <PaymentButton
 265 â”‚                 course={course}
 266 â”‚                 className="flex-1"
 267 â”‚                 size="lg"
 268 â”‚                 onPaymentSuccess={handlePaymentSuccess}
 269 â”‚               />
 270 â”‚             )}
 271 â”‚ 
 272 â”‚             {accessMessage.actionType === 'enrollment' && (
 273 â”‚               <Button 
 274 â”‚                 onClick={handleFreeEnrollment}
 275 â”‚                 disabled={enrolling}
 276 â”‚                 className="flex-1"
 277 â”‚                 size="lg"
 278 â”‚               >
 279 â”‚                 {enrolling ? (
 280 â”‚                   <>
 281 â”‚                     <div className="w-4 h-4 border-2 border-current border-t-transparent rounded-full animate-spin" />
 282 â”‚                     Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„...
 283 â”‚                   </>
 284 â”‚                 ) : (
 285 â”‚                   <>
 286 â”‚                     <UserPlus className="w-4 h-4" />
 287 â”‚                     {accessMessage.actionText}
 288 â”‚                   </>
 289 â”‚                 )}
 290 â”‚               </Button>
 291 â”‚             )}
 292 â”‚ 
 293 â”‚             {accessMessage.actionType === 'contact' && (
 294 â”‚               <Button variant="outline" className="flex-1" size="lg">
 295 â”‚                 <ExternalLink className="w-4 h-4" />
 296 â”‚                 {accessMessage.actionText}
 297 â”‚               </Button>
 298 â”‚             )}
 299 â”‚           </div>
 300 â”‚ 
 301 â”‚           {/* Additional Actions */}
 302 â”‚           <div className="flex justify-center">
 303 â”‚             <Button variant="ghost" asChild>
 304 â”‚               <Link href="/courses">
 305 â”‚                 Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø¯ÙˆØ±Ø§Øª
 306 â”‚               </Link>
 307 â”‚             </Button>
 308 â”‚           </div>
 309 â”‚         </CardContent>
 310 â”‚       </Card>
 311 â”‚ 
 312 â”‚       {/* Fallback Content */}
 313 â”‚       {fallback && (
 314 â”‚         <div className="opacity-50 pointer-events-none">
 315 â”‚           {fallback}
 316 â”‚         </div>
 317 â”‚       )}
 318 â”‚     </div>
 319 â”‚   );
 320 â”‚ }
 321 â”‚ 
 322 â”‚ // Higher-order component for protecting entire pages
 323 â”‚ export function withCourseAccess<P extends object>(
 324 â”‚   Component: React.ComponentType<P>,
 325 â”‚   options: {
 326 â”‚     courseIdProp?: keyof P;
 327 â”‚     fallback?: ReactNode;
 328 â”‚     showAccessInfo?: boolean;
 329 â”‚   } = {}
 330 â”‚ ) {
 331 â”‚   const { courseIdProp = 'courseId', fallback, showAccessInfo = true } = options;
 332 â”‚ 
 333 â”‚   return function ProtectedComponent(props: P) {
 334 â”‚     const courseId = (props as any)[courseIdProp] as string;
 335 â”‚ 
 336 â”‚     if (!courseId) {
 337 â”‚       return (
 338 â”‚         <Card>
 339 â”‚           <CardContent className="text-center py-8">
 340 â”‚             <AlertCircle className="w-12 h-12 mx-auto mb-4 text-red-600" />
 341 â”‚             <h3 className="text-lg font-semibold mb-2">Ù…Ø¹Ø±Ù Ø§Ù„Ø¯ÙˆØ±Ø© Ù…ÙÙ‚ÙˆØ¯</h3>
 342 â”‚             <p className="text-muted-foreground">Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ù…Ø¹Ø±Ù Ø§Ù„Ø¯ÙˆØ±Ø©</p>
 343 â”‚           </CardContent>
 344 â”‚         </Card>
 345 â”‚       );
 346 â”‚     }
 347 â”‚ 
 348 â”‚     return (
 349 â”‚       <CourseAccessGuard
 350 â”‚         courseId={courseId}
 351 â”‚         fallback={fallback}
 352 â”‚         showAccessInfo={showAccessInfo}
 353 â”‚       >
 354 â”‚         <Component {...props} />
 355 â”‚       </CourseAccessGuard>
 356 â”‚     );
 357 â”‚   };
 358 â”‚ }

â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²
END OF FILE: CourseAccessGuard.tsx
â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²


â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
ğŸ”— INTEGRATION LAYER
â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ

â–¼ Free Enrollment
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

ğŸ“„ FILE: route.ts
ğŸ“‚ PATH: src/app/api/courses/[id]/enroll-free/route.ts
ğŸ“Š STATS: 46 lines | 1.31 KB
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ FILE CONTENT:                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   1 â”‚ // src/app/api/courses/[id]/enroll-free/route.ts
   2 â”‚ import { NextRequest, NextResponse } from 'next/server';
   3 â”‚ import { auth } from '@/lib/auth';
   4 â”‚ import { enrollInFreeCourse } from '@/lib/services/enrollment/core.service';
   5 â”‚ 
   6 â”‚ interface RouteParams {
   7 â”‚   params: { id: string }
   8 â”‚ }
   9 â”‚ 
  10 â”‚ // POST /api/courses/[id]/enroll-free - Enroll in free course
  11 â”‚ export async function POST(_request: NextRequest, { params }: RouteParams) {
  12 â”‚   try {
  13 â”‚     const session = await auth();
  14 â”‚     
  15 â”‚     if (!session?.user?.id) {
  16 â”‚       return NextResponse.json({
  17 â”‚         success: false,
  18 â”‚         message: 'ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹'
  19 â”‚       }, { status: 401 });
  20 â”‚     }
  21 â”‚ 
  22 â”‚     const { id: courseId } = await params;
  23 â”‚ 
  24 â”‚     const result = await enrollInFreeCourse(courseId, session.user.id);
  25 â”‚ 
  26 â”‚     if (result.success) {
  27 â”‚       return NextResponse.json({
  28 â”‚         success: true,
  29 â”‚         message: result.message,
  30 â”‚         enrollmentId: result.enrollmentId
  31 â”‚       });
  32 â”‚     } else {
  33 â”‚       return NextResponse.json({
  34 â”‚         success: false,
  35 â”‚         message: result.message
  36 â”‚       }, { status: 400 });
  37 â”‚     }
  38 â”‚ 
  39 â”‚   } catch (error) {
  40 â”‚     console.error('Free enrollment API error:', error);
  41 â”‚     return NextResponse.json({
  42 â”‚       success: false,
  43 â”‚       message: 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙÙŠ Ø§Ù„Ø¯ÙˆØ±Ø©'
  44 â”‚     }, { status: 500 });
  45 â”‚   }
  46 â”‚ }

â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²
END OF FILE: route.ts
â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                              SUMMARY REPORT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“Š Total Files Analyzed: 20
âœ… Successfully Processed: 20
âŒ Missing Files: 0
ğŸ“ˆ Total Lines of Code: 3,632
ğŸ—ï¸  Architecture: Payment & Enrollment Core Services
ğŸŒ Project Location: Egypt

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Report generated by Payment & Enrollment Services Analyzer
Timestamp: 2025-08-08T16:07:05.202Z
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
